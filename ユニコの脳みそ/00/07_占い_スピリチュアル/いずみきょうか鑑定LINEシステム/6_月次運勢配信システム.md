---
tags: [Monthly_Fortune, Subscription, System_Docs, IzumiKyoka, 00]
date: 2026-01-20
source: ãƒ¦ãƒ‹ã‚³ã®è„³ã¿ã/00
aliases: [6_æœˆæ¬¡é‹å‹¢é…ä¿¡ã‚·ã‚¹ãƒ†ãƒ , Monthly_Fortune_System]
---

[[00_çŸ¥è­˜ãƒãƒƒãƒ—]]

# 6ï¸âƒ£ æœˆæ¬¡é‹å‹¢é…ä¿¡ã‚·ã‚¹ãƒ†ãƒ 

**æ–°æ©Ÿèƒ½ï¼šæ¯æœˆå…¨å“¡ã«ç°¡æ˜“é‹å‹¢ã‚’é…ä¿¡ã—ã€ã‚µãƒ–ã‚¹ã‚¯å¥‘ç´„ã§è©³ç´°é‘‘å®š**

æ¯æœˆ25æ—¥ï½30æ—¥ã«ç°¡æ˜“é‹å‹¢ã‚’é…ä¿¡ã€è©³ã—ãçŸ¥ã‚ŠãŸã„äººã«ã¯ã‚µãƒ–ã‚¹ã‚¯å¥‘ç´„ã§è©³ç´°é‘‘å®šã‚’æä¾›ã—ã¾ã™ã€‚

---

## ğŸ¯ ã‚·ã‚¹ãƒ†ãƒ æ¦‚è¦

### é…ä¿¡ã®æµã‚Œ

```
ã€æ¯æœˆ25æ—¥ã€‘
ã‚µãƒ–ã‚¹ã‚¯æ±ºæ¸ˆè€…ã«èª²é‡‘
  â†“
25ï½30æ—¥ã®é–“ã«
  â†“
ã€å„ªå…ˆ1ã€‘ã‚µãƒ–ã‚¹ã‚¯å¥‘ç´„è€…ã«è©³ç´°é‹å‹¢é‘‘å®š
ã€å„ªå…ˆ2ã€‘å…¨ãƒ¡ãƒ¼ãƒ«ç™»éŒ²è€…ã«ç°¡æ˜“é‹å‹¢é‘‘å®š
  â†“
ç°¡æ˜“é‘‘å®šãƒ¡ãƒ¼ãƒ«ã«ã€Œè©³ç´°ç‰ˆã¯ã“ã¡ã‚‰ã€æ¡ˆå†…
  â†“
ã‚µãƒ–ã‚¹ã‚¯å¥‘ç´„ã¸èª˜å°
```

### ç°¡æ˜“é‹å‹¢ã¨è©³ç´°é‹å‹¢ã®é•ã„

| é …ç›® | ç°¡æ˜“é‹å‹¢ï¼ˆç„¡æ–™ï¼‰ | è©³ç´°é‹å‹¢ï¼ˆã‚µãƒ–ã‚¹ã‚¯ï¼‰ |
|------|----------------|-------------------|
| **å¯¾è±¡** | å…¨ãƒ¡ãƒ¼ãƒ«ç™»éŒ²è€… | ã‚µãƒ–ã‚¹ã‚¯å¥‘ç´„è€…ã®ã¿ |
| **é…ä¿¡æ—¥** | 25ï½30æ—¥oræœˆåˆ | 25ï½27æ—¥ï¼ˆå„ªå…ˆï¼‰ |
| **å†…å®¹** | å‰æ—¥ãƒ»å„æ—¥ãƒ»ä¸€è¡Œã‚¢ãƒ‰ãƒã‚¤ã‚¹ | è©³ç´°ãª1ãƒ¶æœˆã®è¡Œå‹•æŒ‡é‡ |
| **æ–‡å­—æ•°** | 300æ–‡å­—ç¨‹åº¦ | 2,000æ–‡å­—ç¨‹åº¦ |
| **æ–™é‡‘** | ç„¡æ–™ | Â¥2,980/æœˆ |
| **ç”Ÿæˆ** | OpenAI API | OpenAI APIï¼ˆåŒã˜åŸºæº–ã§ï¼‰ |

---

## ğŸ“Š Step 6-1: ã‚µãƒ–ã‚¹ã‚¯å•†å“ã®è¿½åŠ ï¼ˆ5åˆ†ï¼‰

### 1. products ã‚·ãƒ¼ãƒˆã«è¿½åŠ 

```
product_id	name	price	description	detail_html	image_url	active	category	sort_order	is_subscription
PROD_SUB_001	æœˆæ¬¡è©³ç´°é‹å‹¢ï¼ˆã‚µãƒ–ã‚¹ã‚¯ï¼‰	2980	æ¯æœˆã‚ãªãŸå°‚ç”¨ã®è©³ç´°é‹å‹¢	<h3>ğŸŒ™ æœˆæ¬¡è©³ç´°é‹å‹¢ã«ã¤ã„ã¦</h3><p>æ¯æœˆ25æ—¥ã«ã€ã‚ãªãŸå°‚ç”¨ã®è©³ç´°é‹å‹¢ã‚’ãŠå±Šã‘ã—ã¾ã™ã€‚</p><h4>ğŸ“… ãŠå±Šã‘å†…å®¹</h4><ul><li>ãã®æœˆã®å…¨ä½“é‹å‹¢</li><li>æ—¥åˆ¥ã®å‰æ—¥ãƒ»å„æ—¥ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</li><li>æ‹æ„›ãƒ»ä»•äº‹ãƒ»å¥åº·ãƒ»é‡‘é‹ã®è©³ç´°</li><li>é€±ã”ã¨ã®è¡Œå‹•ã‚¢ãƒ‰ãƒã‚¤ã‚¹</li><li>é–‹é‹ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆ10å€‹ï¼‰</li><li>æ³¨æ„ã™ã¹ãæ—¥ã¨å¯¾ç­–</li></ul><h4>ğŸ’° æ–™é‡‘</h4><p>æœˆé¡ Â¥2,980ï¼ˆç¨è¾¼ï¼‰</p><p>â€»å€‹åˆ¥é‘‘å®šï¼ˆÂ¥5,000ï¼‰ã‚ˆã‚Š40%ä»¥ä¸ŠãŠå¾—</p><p>â€»ã„ã¤ã§ã‚‚è§£ç´„å¯èƒ½</p>		TRUE	ã‚µãƒ–ã‚¹ã‚¯	100	TRUE
```

**æ–°ã—ã„åˆ—**: `is_subscription`ï¼ˆTRUE/FALSEï¼‰

### 2. products ã‚·ãƒ¼ãƒˆã«åˆ—ã‚’è¿½åŠ 

æ—¢å­˜ã®productsã‚·ãƒ¼ãƒˆã®æœ€å¾Œã«åˆ—ã‚’è¿½åŠ ï¼š
- Kåˆ—ï¼š`is_subscription`ï¼ˆã‚µãƒ–ã‚¹ã‚¯ã‹ã©ã†ã‹ï¼‰

æ—¢å­˜å•†å“ã¯ã™ã¹ã¦ `FALSE` ã«è¨­å®šã€‚

---

## ğŸ“ Step 6-2: æœˆæ¬¡é‹å‹¢ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®è¿½åŠ ï¼ˆ10åˆ†ï¼‰

### ai_prompts ã‚·ãƒ¼ãƒˆã«è¿½åŠ 

#### ç°¡æ˜“é‹å‹¢ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼ˆå…¨å“¡å‘ã‘ï¼‰

```
MONTHLY_SIMPLE	monthly	ALL	æœˆæ¬¡ç°¡æ˜“é‹å‹¢ï¼ˆå…¨å“¡ï¼‰	{name}æ§˜ã®{year}å¹´{month}æœˆã®ç°¡æ˜“é‹å‹¢ã‚’å ã£ã¦ãã ã•ã„ã€‚\n\nã€åŸºæœ¬æƒ…å ±ã€‘\n{user_info}\n\nã€é…ä¿¡å¯¾è±¡ã€‘å…¨ãƒ¡ãƒ¼ãƒ«ç™»éŒ²è€…ï¼ˆç„¡æ–™ï¼‰\n\nã€å ã†å†…å®¹ã€‘\n1. ãã®æœˆã®å…¨ä½“çš„ãªé‹å‹¢ï¼ˆä¸€è¨€ï¼‰\n2. ç‰¹ã«è‰¯ã„æ—¥ï¼ˆå‰æ—¥ï¼‰ã‚’3ã¤\n3. æ³¨æ„ãŒå¿…è¦ãªæ—¥ï¼ˆå„æ—¥ï¼‰ã‚’2ã¤\n4. é–‹é‹ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆ1ã¤ï¼‰\n5. é¿ã‘ã‚‹ã¹ãè¡Œå‹•ï¼ˆ1ã¤ï¼‰\n\nã€æ–‡å­—æ•°ã€‘300æ–‡å­—ä»¥å†…\nã€ã‚¹ã‚¿ã‚¤ãƒ«ã€‘ç°¡æ½”ã§åˆ†ã‹ã‚Šã‚„ã™ãã€ãƒã‚¸ãƒ†ã‚£ãƒ–ã«\nã€ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã€‘\n## {month}æœˆã®é‹å‹¢\nå…¨ä½“é‹: ï¼ˆä¸€è¨€ã§ï¼‰\n\nğŸŒŸ å‰æ—¥: ã€‡æ—¥ã€â–³æ—¥ã€â–¡æ—¥\nâš ï¸ æ³¨æ„æ—¥: Ã—æ—¥ã€â–½æ—¥\n\nâœ¨ é–‹é‹ã‚¢ã‚¯ã‚·ãƒ§ãƒ³: ...\nâ›” é¿ã‘ã‚‹ã“ã¨: ...	TRUE	1	ç°¡æ˜“é‹å‹¢
```

#### è©³ç´°é‹å‹¢ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼ˆã‚µãƒ–ã‚¹ã‚¯ç”¨ï¼‰

```
MONTHLY_DETAIL	monthly	PROD_SUB_001	æœˆæ¬¡è©³ç´°é‹å‹¢ï¼ˆã‚µãƒ–ã‚¹ã‚¯ï¼‰	{name}æ§˜ã®{year}å¹´{month}æœˆã®è©³ç´°é‹å‹¢ã‚’å ã£ã¦ãã ã•ã„ã€‚\n\nã€åŸºæœ¬æƒ…å ±ã€‘\n{user_info}\n\nã€å‰æã€‘\nã“ã®æ–¹ã¯ã‚µãƒ–ã‚¹ã‚¯å¥‘ç´„è€…ã§ã™ã€‚ç°¡æ˜“é‹å‹¢ã‚‚é…ä¿¡ã•ã‚Œã¦ã„ã‚‹ã®ã§ã€ãã‚Œã¨çŸ›ç›¾ã—ãªã„å†…å®¹ã«ã—ã¦ãã ã•ã„ã€‚\n\nã€å ã†å†…å®¹ã€‘\n1. ãã®æœˆã®å…¨ä½“é‹å‹¢ï¼ˆè©³ã—ãï¼‰\n2. é€±åˆ¥ã®é‹å‹¢ã¨è¡Œå‹•ã‚¢ãƒ‰ãƒã‚¤ã‚¹\n   - ç¬¬1é€±ï¼ˆ1ï½7æ—¥ï¼‰\n   - ç¬¬2é€±ï¼ˆ8ï½14æ—¥ï¼‰\n   - ç¬¬3é€±ï¼ˆ15ï½21æ—¥ï¼‰\n   - ç¬¬4é€±ï¼ˆ22ï½æœˆæœ«ï¼‰\n3. æ—¥åˆ¥ã®å‰æ—¥ãƒ»å„æ—¥ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼\n4. æ‹æ„›é‹ã®è©³ç´°ï¼ˆå‡ºä¼šã„ã€ãƒ‡ãƒ¼ãƒˆã€å‘Šç™½ãªã©ï¼‰\n5. ä»•äº‹é‹ã®è©³ç´°ï¼ˆå•†è«‡ã€ãƒ—ãƒ¬ã‚¼ãƒ³ã€è»¢è·ãªã©ï¼‰\n6. å¥åº·é‹ã¨ã‚±ã‚¢æ–¹æ³•\n7. é‡‘é‹ã¨ãŠé‡‘ã®ä½¿ã„æ–¹\n8. äººé–“é–¢ä¿‚ã®æ³¨æ„ç‚¹\n9. é‡è¦ãªæ—¥ã¨ãã®å¯¾å‡¦æ³•ï¼ˆå…·ä½“çš„ã«ï¼‰\n10. é–‹é‹ã‚¢ã‚¯ã‚·ãƒ§ãƒ³10å€‹ï¼ˆæ—¥ä»˜æŒ‡å®šã§ï¼‰\n11. é¿ã‘ã‚‹ã¹ãè¡Œå‹•5ã¤\n12. ãã®æœˆã®ãƒ©ãƒƒã‚­ãƒ¼ã‚«ãƒ©ãƒ¼ãƒ»ãƒŠãƒ³ãƒãƒ¼ãƒ»æ–¹è§’\n13. æœˆæœ«ã«å‘ã‘ã¦ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸\n\nã€æ–‡å­—æ•°ã€‘2,000æ–‡å­—ç¨‹åº¦\nã€ã‚¹ã‚¿ã‚¤ãƒ«ã€‘å…·ä½“çš„ã§å®Ÿè·µçš„ã«ã€‚ã€Œã€‡æ—¥ã¯â–³â–³ã™ã‚‹ã¨è‰¯ã„ã€ã®ã‚ˆã†ã«æ—¥ä»˜æŒ‡å®šã§\nã€æ³¨æ„ã€‘ç°¡æ˜“é‹å‹¢ã§ä¼ãˆãŸå‰æ—¥ãƒ»å„æ—¥ã¨çŸ›ç›¾ã—ãªã„ã“ã¨	TRUE	100	è©³ç´°é‹å‹¢
```

---

## âš™ï¸ Step 6-3: Code.gs ã«æœˆæ¬¡é…ä¿¡å‡¦ç†ã‚’è¿½åŠ ï¼ˆ15åˆ†ï¼‰

### 1. tick()ã«è¿½åŠ 

```javascript
function tick() {
  const config = getConfig_();
  if (config.freeze_all) {
    log_('tick: freeze_all ãŒæœ‰åŠ¹ã®ãŸã‚ã€å…¨å‡¦ç†ã‚’ã‚¹ã‚­ãƒƒãƒ—');
    return;
  }
  
  try {
    log_('=== tick() é–‹å§‹ ===');
    
    processNewApplications_();
    processConsultDecisions_();
    processAppointmentReminders_();
    processManualPayments_();
    processScheduledAIReadings_();
    
    // â˜… æœˆæ¬¡é‹å‹¢é…ä¿¡ã‚’è¿½åŠ 
    processMonthlyFortuneDistribution_();
    
    processSendQueue_();
    
    log_('=== tick() å®Œäº† ===');
  } catch (e) {
    log_('tick: ã‚¨ãƒ©ãƒ¼ - ' + e.toString());
    notifyOpsError_(e);
  }
}
```

### 2. æœˆæ¬¡é…ä¿¡å‡¦ç†é–¢æ•°

```javascript
// ================================================================================
// æœˆæ¬¡é‹å‹¢é…ä¿¡ã‚·ã‚¹ãƒ†ãƒ 
// ================================================================================

/**
 * æœˆæ¬¡é‹å‹¢é…ä¿¡ã®å‡¦ç†
 */
function processMonthlyFortuneDistribution_() {
  const now = new Date();
  const today = now.getDate();
  const month = now.getMonth() + 1;
  const year = now.getFullYear();
  
  // 25æ—¥ï½30æ—¥ã®æœŸé–“ã®ã¿å®Ÿè¡Œ
  if (today < 25 || today > 30) {
    return;
  }
  
  // ä»Šæ—¥ã™ã§ã«å‡¦ç†æ¸ˆã¿ã‹ãƒã‚§ãƒƒã‚¯
  if (isMonthlyFortuneProcessedToday_()) {
    return;
  }
  
  log_('processMonthlyFortuneDistribution_: æœˆæ¬¡é‹å‹¢é…ä¿¡é–‹å§‹');
  
  // 1. ã‚µãƒ–ã‚¹ã‚¯å¥‘ç´„è€…ã®ç¢ºèªãƒ»èª²é‡‘
  if (today === 25) {
    processSubscriptionBilling_();
  }
  
  // 2. é…ä¿¡å¯¾è±¡è€…ã‚’å–å¾—
  const subscribers = getActiveSubscribers_();
  const allUsers = getAllEmailUsers_();
  const nonSubscribers = allUsers.filter(user => {
    return !subscribers.find(sub => sub.user_id === user.user_id);
  });
  
  // 3. å„ªå…ˆåº¦1: ã‚µãƒ–ã‚¹ã‚¯å¥‘ç´„è€…ã«è©³ç´°é‹å‹¢é…ä¿¡
  distributeDetailedFortune_(subscribers, year, month + 1);
  
  // 4. å„ªå…ˆåº¦2: éå¥‘ç´„è€…ã«ç°¡æ˜“é‹å‹¢é…ä¿¡
  distributeSimpleFortune_(nonSubscribers, year, month + 1);
  
  // 5. ä»Šæ—¥ã®å‡¦ç†å®Œäº†ãƒ•ãƒ©ã‚°
  markMonthlyFortuneProcessed_();
  
  log_('processMonthlyFortuneDistribution_: æœˆæ¬¡é‹å‹¢é…ä¿¡å®Œäº†');
}

/**
 * ä»Šæ—¥ã™ã§ã«æœˆæ¬¡é‹å‹¢å‡¦ç†æ¸ˆã¿ã‹ãƒã‚§ãƒƒã‚¯
 */
function isMonthlyFortuneProcessedToday_() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  let processLog = ss.getSheetByName('monthly_fortune_log');
  
  if (!processLog) {
    processLog = ss.insertSheet('monthly_fortune_log');
    processLog.appendRow(['process_date', 'year', 'month', 'simple_count', 'detailed_count', 'status']);
    return false;
  }
  
  const data = processLog.getDataRange().getValues();
  const today = Utilities.formatDate(new Date(), TIMEZONE, 'yyyy-MM-dd');
  
  for (let i = 1; i < data.length; i++) {
    const processDate = Utilities.formatDate(new Date(data[i][0]), TIMEZONE, 'yyyy-MM-dd');
    if (processDate === today && data[i][5] === 'completed') {
      return true;
    }
  }
  
  return false;
}

/**
 * æœˆæ¬¡é‹å‹¢å‡¦ç†å®Œäº†ã‚’ãƒãƒ¼ã‚¯
 */
function markMonthlyFortuneProcessed_() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  let processLog = ss.getSheetByName('monthly_fortune_log');
  
  const now = new Date();
  const nextMonth = new Date(now.getFullYear(), now.getMonth() + 1, 1);
  
  processLog.appendRow([
    now,
    nextMonth.getFullYear(),
    nextMonth.getMonth() + 1,
    0, // ã‚«ã‚¦ãƒ³ãƒˆã¯å¾Œã§æ›´æ–°
    0,
    'completed'
  ]);
}

/**
 * ã‚µãƒ–ã‚¹ã‚¯å¥‘ç´„è€…ã‚’å–å¾—
 */
function getActiveSubscribers_() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  let subSheet = ss.getSheetByName('subscriptions');
  
  if (!subSheet) {
    subSheet = ss.insertSheet('subscriptions');
    subSheet.appendRow(['subscription_id', 'user_id', 'product_id', 'status', 'started_at', 'next_billing_date', 'cancelled_at']);
    return [];
  }
  
  const data = subSheet.getDataRange().getValues();
  const subscribers = [];
  
  for (let i = 1; i < data.length; i++) {
    const row = data[i];
    if (row[3] === 'active') {
      const user = getUser_(row[1]);
      if (user) {
        subscribers.push({
          subscription_id: row[0],
          user_id: row[1],
          user: user
        });
      }
    }
  }
  
  return subscribers;
}

/**
 * å…¨ãƒ¡ãƒ¼ãƒ«ç™»éŒ²ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å–å¾—
 */
function getAllEmailUsers_() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const userSheet = ss.getSheetByName('users');
  
  if (!userSheet) return [];
  
  const data = userSheet.getDataRange().getValues();
  const users = [];
  
  for (let i = 1; i < data.length; i++) {
    const email = data[i][2];
    const unsubscribed = data[i][6];
    
    if (email && !unsubscribed) {
      users.push({
        user_id: data[i][0],
        name: data[i][1],
        email: data[i][2],
        birth_date: data[i][3]
      });
    }
  }
  
  return users;
}

/**
 * ã‚µãƒ–ã‚¹ã‚¯å¥‘ç´„è€…ã«è©³ç´°é‹å‹¢é…ä¿¡
 */
function distributeDetailedFortune_(subscribers, year, month) {
  const now = new Date();
  
  subscribers.forEach(subscriber => {
    const user = subscriber.user;
    
    // AIé‘‘å®šã‚’ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼ˆå³åº§ã¾ãŸã¯æ•°æ™‚é–“å¾Œï¼‰
    const scheduledTime = new Date(now.getTime() + (Math.random() * 6) * 60 * 60 * 1000); // 0ã€œ6æ™‚é–“å¾Œã«ãƒ©ãƒ³ãƒ€ãƒ åˆ†æ•£
    
    scheduleMonthlyFortune_(user.user_id, 'detailed', year, month, scheduledTime);
  });
  
  log_(`distributeDetailedFortune_: ${subscribers.length}ä»¶ã®è©³ç´°é‹å‹¢ã‚’ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«`);
}

/**
 * éå¥‘ç´„è€…ã«ç°¡æ˜“é‹å‹¢é…ä¿¡
 */
function distributeSimpleFortune_(users, year, month) {
  const now = new Date();
  const today = now.getDate();
  
  // 25ã€œ30æ—¥ã®é–“ã«åˆ†æ•£é…ä¿¡ï¼ˆ1æ—¥ã‚ãŸã‚Šå‡ç­‰ã«ï¼‰
  const daysLeft = 31 - today; // 30æ—¥ã¾ã§
  const usersPerDay = Math.ceil(users.length / daysLeft);
  
  users.forEach((user, index) => {
    // é…ä¿¡æ—¥ã‚’åˆ†æ•£
    const dayOffset = Math.floor(index / usersPerDay);
    const scheduledTime = new Date(now.getTime() + dayOffset * 24 * 60 * 60 * 1000 + (Math.random() * 12) * 60 * 60 * 1000);
    
    scheduleMonthlyFortune_(user.user_id, 'simple', year, month, scheduledTime);
  });
  
  log_(`distributeSimpleFortune_: ${users.length}ä»¶ã®ç°¡æ˜“é‹å‹¢ã‚’ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«`);
}

/**
 * æœˆæ¬¡é‹å‹¢ã‚’ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«
 */
function scheduleMonthlyFortune_(userId, fortuneType, year, month, scheduledTime) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  let scheduleSheet = ss.getSheetByName('monthly_fortune_schedule');
  
  if (!scheduleSheet) {
    scheduleSheet = ss.insertSheet('monthly_fortune_schedule');
    scheduleSheet.appendRow([
      'schedule_id', 'user_id', 'fortune_type', 'year', 'month', 
      'scheduled_at', 'status', 'created_at', 'processed_at', 'reading_id'
    ]);
  }
  
  const scheduleId = 'MF_' + Utilities.getUuid();
  scheduleSheet.appendRow([
    scheduleId, userId, fortuneType, year, month, 
    scheduledTime, 'pending', new Date(), '', ''
  ]);
}

/**
 * ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã•ã‚ŒãŸæœˆæ¬¡é‹å‹¢ã‚’å‡¦ç†
 */
function processMonthlyFortuneSchedule_() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const scheduleSheet = ss.getSheetByName('monthly_fortune_schedule');
  
  if (!scheduleSheet) return;
  
  const data = scheduleSheet.getDataRange().getValues();
  if (data.length <= 1) return;
  
  const now = new Date();
  let processedCount = 0;
  const maxPerTick = 5; // 1å›ã«ã¤ã5ä»¶ã¾ã§ï¼ˆå®Ÿè¡Œæ™‚é–“å¯¾ç­–ï¼‰
  
  for (let i = 1; i < data.length; i++) {
    if (processedCount >= maxPerTick) break;
    
    const row = data[i];
    if (row[6] !== 'pending') continue;
    if (new Date(row[5]) > now) continue;
    
    try {
      const userId = row[1];
      const fortuneType = row[2];
      const year = row[3];
      const month = row[4];
      
      const readingId = generateMonthlyFortune_(userId, fortuneType, year, month);
      
      scheduleSheet.getRange(i + 1, 7).setValue('completed');
      scheduleSheet.getRange(i + 1, 9).setValue(now);
      scheduleSheet.getRange(i + 1, 10).setValue(readingId);
      
      processedCount++;
      
    } catch (error) {
      log_('processMonthlyFortuneSchedule_: ã‚¨ãƒ©ãƒ¼ - ' + error.toString());
      scheduleSheet.getRange(i + 1, 7).setValue('error');
    }
  }
  
  if (processedCount > 0) {
    log_(`processMonthlyFortuneSchedule_: ${processedCount}ä»¶ã®æœˆæ¬¡é‹å‹¢ã‚’å‡¦ç†`);
  }
}

/**
 * æœˆæ¬¡é‹å‹¢ã‚’ç”Ÿæˆã—ã¦é€ä¿¡
 */
function generateMonthlyFortune_(userId, fortuneType, year, month) {
  const user = getUser_(userId);
  if (!user) {
    throw new Error('ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: ' + userId);
  }
  
  log_(`generateMonthlyFortune_: æœˆæ¬¡é‹å‹¢ç”Ÿæˆé–‹å§‹ - ${user.name}, ${fortuneType}`);
  
  // ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå–å¾—
  const promptId = fortuneType === 'detailed' ? 'MONTHLY_DETAIL' : 'MONTHLY_SIMPLE';
  const prompt = getMonthlyFortunePrompt_(promptId, user, year, month);
  
  // AIç”Ÿæˆ
  const result = callOpenAI_(prompt, fortuneType === 'detailed' ? 2000 : 500);
  
  // è¨˜éŒ²
  const readingId = 'MF_' + year + '_' + month + '_' + Utilities.getUuid();
  recordMonthlyFortune_(userId, readingId, fortuneType, year, month, result);
  
  // ãƒ¡ãƒ¼ãƒ«é€ä¿¡
  sendMonthlyFortuneEmail_(user, fortuneType, year, month, result.text);
  
  log_(`generateMonthlyFortune_: å®Œäº† - ${readingId}`);
  
  return readingId;
}

/**
 * æœˆæ¬¡é‹å‹¢ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å–å¾—
 */
function getMonthlyFortunePrompt_(promptId, user, year, month) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const promptsSheet = ss.getSheetByName('ai_prompts');
  
  if (!promptsSheet) {
    return buildDefaultMonthlyPrompt_(user, year, month);
  }
  
  const data = promptsSheet.getDataRange().getValues();
  
  for (let i = 1; i < data.length; i++) {
    const row = data[i];
    if (row[0] === promptId && row[5] === true) {
      const template = row[4].replace(/\\n/g, '\n');
      return fillMonthlyPromptVariables_(template, user, year, month);
    }
  }
  
  return buildDefaultMonthlyPrompt_(user, year, month);
}

/**
 * æœˆæ¬¡ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®å¤‰æ•°ã‚’ç½®æ›
 */
function fillMonthlyPromptVariables_(template, user, year, month) {
  const birthDate = new Date(user.birth_date);
  const age = calculateAge_(birthDate);
  const zodiacSign = getZodiacSign_(birthDate);
  const chineseZodiac = getChineseZodiac_(birthDate.getFullYear());
  
  const userInfo = `ãŠåå‰: ${user.name}æ§˜
ç”Ÿå¹´æœˆæ—¥: ${formatDate_(birthDate)}
å¹´é½¢: ${age}æ­³
æ˜Ÿåº§: ${zodiacSign}
å¹²æ”¯: ${chineseZodiac}`;
  
  return template
    .replace(/{user_info}/g, userInfo)
    .replace(/{name}/g, user.name)
    .replace(/{year}/g, year)
    .replace(/{month}/g, month)
    .replace(/{age}/g, age)
    .replace(/{zodiac_sign}/g, zodiacSign)
    .replace(/{chinese_zodiac}/g, chineseZodiac);
}

/**
 * OpenAI APIå‘¼ã³å‡ºã—ï¼ˆæ±ç”¨ï¼‰
 */
function callOpenAI_(prompt, maxTokens) {
  const config = getConfig_();
  const aiSettings = getAISettings_();
  const apiKey = config.openai_api_key;
  const model = config.openai_model || 'gpt-4o-mini';
  
  const systemPrompt = getSystemPromptFromSheet_();
  
  const url = 'https://api.openai.com/v1/chat/completions';
  const payload = {
    model: model,
    messages: [
      { role: 'system', content: systemPrompt },
      { role: 'user', content: prompt }
    ],
    temperature: parseFloat(aiSettings.default_temperature) || 0.7,
    max_tokens: maxTokens
  };
  
  const options = {
    method: 'post',
    headers: {
      'Authorization': 'Bearer ' + apiKey,
      'Content-Type': 'application/json'
    },
    payload: JSON.stringify(payload),
    muteHttpExceptions: true
  };
  
  const response = UrlFetchApp.fetch(url, options);
  const statusCode = response.getResponseCode();
  
  if (statusCode !== 200) {
    throw new Error('OpenAI API ã‚¨ãƒ©ãƒ¼: ' + statusCode);
  }
  
  const result = JSON.parse(response.getContentText());
  
  return {
    text: result.choices[0].message.content,
    tokens_used: result.usage.total_tokens,
    model: model
  };
}

/**
 * æœˆæ¬¡é‹å‹¢ã‚’è¨˜éŒ²
 */
function recordMonthlyFortune_(userId, readingId, fortuneType, year, month, result) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  let fortuneSheet = ss.getSheetByName('monthly_fortunes');
  
  if (!fortuneSheet) {
    fortuneSheet = ss.insertSheet('monthly_fortunes');
    fortuneSheet.appendRow([
      'reading_id', 'user_id', 'fortune_type', 'year', 'month', 
      'content', 'sent_at', 'tokens_used', 'model'
    ]);
  }
  
  fortuneSheet.appendRow([
    readingId, userId, fortuneType, year, month,
    result.text, new Date(), result.tokens_used, result.model
  ]);
}

/**
 * æœˆæ¬¡é‹å‹¢ãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡
 */
function sendMonthlyFortuneEmail_(user, fortuneType, year, month, fortuneText) {
  if (fortuneType === 'detailed') {
    // è©³ç´°é‹å‹¢ï¼ˆã‚µãƒ–ã‚¹ã‚¯å¥‘ç´„è€…ï¼‰
    addToSendQueue_(user.user_id, 'tmpl_monthly_detailed', {
      name: user.name,
      year: year,
      month: month,
      fortune_content: fortuneText
    }, new Date());
    
  } else {
    // ç°¡æ˜“é‹å‹¢ï¼ˆå…¨å“¡ï¼‰
    addToSendQueue_(user.user_id, 'tmpl_monthly_simple', {
      name: user.name,
      year: year,
      month: month,
      fortune_content: fortuneText,
      subscription_link: getLink_('L9000') // ã‚µãƒ–ã‚¹ã‚¯æ¡ˆå†…ãƒªãƒ³ã‚¯
    }, new Date());
  }
}

/**
 * ã‚µãƒ–ã‚¹ã‚¯èª²é‡‘å‡¦ç†ï¼ˆæ¯æœˆ25æ—¥ï¼‰
 */
function processSubscriptionBilling_() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const subSheet = ss.getSheetByName('subscriptions');
  
  if (!subSheet) return;
  
  const data = subSheet.getDataRange().getValues();
  const now = new Date();
  
  for (let i = 1; i < data.length; i++) {
    const row = data[i];
    const status = row[3];
    const nextBillingDate = new Date(row[5]);
    
    if (status === 'active' && nextBillingDate <= now) {
      // èª²é‡‘å‡¦ç†ï¼ˆå®Ÿéš›ã¯PayPalã§è‡ªå‹•èª²é‡‘ã•ã‚Œã‚‹æƒ³å®šï¼‰
      // ã“ã“ã§ã¯æ¬¡å›èª²é‡‘æ—¥ã‚’æ›´æ–°
      const newBillingDate = new Date(nextBillingDate);
      newBillingDate.setMonth(newBillingDate.getMonth() + 1);
      
      subSheet.getRange(i + 1, 6).setValue(newBillingDate);
      
      log_(`processSubscriptionBilling_: ã‚µãƒ–ã‚¹ã‚¯èª²é‡‘ - ${row[1]}, æ¬¡å›: ${formatDateTime_(newBillingDate)}`);
    }
  }
}

/**
 * ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®æœˆæ¬¡ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
 */
function buildDefaultMonthlyPrompt_(user, year, month) {
  return `${user.name}æ§˜ã®${year}å¹´${month}æœˆã®é‹å‹¢ã‚’ç°¡æ½”ã«å ã£ã¦ãã ã•ã„ã€‚`;
}
```

### 3. setupSheets()ã«è¿½åŠ 

```javascript
// 24. subscriptionsï¼ˆã‚µãƒ–ã‚¹ã‚¯ç®¡ç†ï¼‰
createSheetIfNotExists_('subscriptions', [
  'subscription_id', 'user_id', 'product_id', 'status', 'started_at', 'next_billing_date', 'cancelled_at'
]);

// 25. monthly_fortunesï¼ˆæœˆæ¬¡é‹å‹¢è¨˜éŒ²ï¼‰
createSheetIfNotExists_('monthly_fortunes', [
  'reading_id', 'user_id', 'fortune_type', 'year', 'month', 'content', 'sent_at', 'tokens_used', 'model'
]);

// 26. monthly_fortune_scheduleï¼ˆæœˆæ¬¡é‹å‹¢ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼‰
createSheetIfNotExists_('monthly_fortune_schedule', [
  'schedule_id', 'user_id', 'fortune_type', 'year', 'month', 'scheduled_at', 'status', 'created_at', 'processed_at', 'reading_id'
]);

// 27. monthly_fortune_logï¼ˆæœˆæ¬¡é‹å‹¢å‡¦ç†ãƒ­ã‚°ï¼‰
createSheetIfNotExists_('monthly_fortune_log', [
  'process_date', 'year', 'month', 'simple_count', 'detailed_count', 'status'
]);
```

### 4. tick()ã«è¿½åŠ 

```javascript
// æœˆæ¬¡é‹å‹¢ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã®å‡¦ç†ã‚‚è¿½åŠ 
processMonthlyFortuneSchedule_();
```

---

## ğŸ“§ Step 6-4: ãƒ¡ãƒ¼ãƒ«ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆè¿½åŠ ï¼ˆ5åˆ†ï¼‰

### email_templates ã‚·ãƒ¼ãƒˆã«è¿½åŠ 

#### ç°¡æ˜“é‹å‹¢ãƒ¡ãƒ¼ãƒ«

```
tmpl_monthly_simple	æœˆæ¬¡ç°¡æ˜“é‹å‹¢	ã€ã„ãšã¿ãã‚‡ã†ã‹ã€‘{{year}}å¹´{{month}}æœˆã®ã‚ãªãŸã®é‹å‹¢	{{name}}æ§˜

{{year}}å¹´{{month}}æœˆã®é‹å‹¢ã‚’ãŠå±Šã‘ã—ã¾ã™ğŸŒ™

{{fortune_content}}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ã‚‚ã£ã¨è©³ã—ãçŸ¥ã‚ŠãŸã„æ–¹ã¸âœ¨

ã€æœˆæ¬¡è©³ç´°é‹å‹¢ã‚µãƒ–ã‚¹ã‚¯ã€‘
æ¯æœˆ25æ—¥ã«ã€ã‚ãªãŸå°‚ç”¨ã®è©³ç´°é‹å‹¢ã‚’ãŠå±Šã‘

ãƒ»æ—¥åˆ¥ã®å‰æ—¥ãƒ»å„æ—¥ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼
ãƒ»é€±ã”ã¨ã®è¡Œå‹•ã‚¢ãƒ‰ãƒã‚¤ã‚¹
ãƒ»é–‹é‹ã‚¢ã‚¯ã‚·ãƒ§ãƒ³10å€‹ï¼ˆæ—¥ä»˜æŒ‡å®šï¼‰
ãƒ»æ‹æ„›ãƒ»ä»•äº‹ãƒ»é‡‘é‹ã®è©³ç´°

æœˆé¡ Â¥2,980ï¼ˆå€‹åˆ¥é‘‘å®šã‚ˆã‚Š40%ãŠå¾—ï¼‰

â–¼è©³ç´°ã¯ã“ã¡ã‚‰
{{subscription_link}}

ã„ãšã¿ãã‚‡ã†ã‹	FALSE	æœˆæ¬¡ç°¡æ˜“é‹å‹¢
```

#### è©³ç´°é‹å‹¢ãƒ¡ãƒ¼ãƒ«ï¼ˆã‚µãƒ–ã‚¹ã‚¯ï¼‰

```
tmpl_monthly_detailed	æœˆæ¬¡è©³ç´°é‹å‹¢ï¼ˆã‚µãƒ–ã‚¹ã‚¯ï¼‰	ã€ã„ãšã¿ãã‚‡ã†ã‹ã€‘{{year}}å¹´{{month}}æœˆã®ã‚ãªãŸå°‚ç”¨è©³ç´°é‹å‹¢	{{name}}æ§˜

ã„ã¤ã‚‚ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™âœ¨

{{year}}å¹´{{month}}æœˆã®ã€ã‚ãªãŸå°‚ç”¨ã®è©³ç´°é‹å‹¢ãŒå®Œæˆã—ã¾ã—ãŸã€‚

{{fortune_content}}

ã“ã®1ãƒ¶æœˆã€ç´ æ™´ã‚‰ã—ã„æ—¥ã€…ã«ãªã‚Šã¾ã™ã‚ˆã†ã«ğŸŒŸ

ã”ä¸æ˜ãªç‚¹ãŒã”ã–ã„ã¾ã—ãŸã‚‰
ã„ã¤ã§ã‚‚ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚

ã„ãšã¿ãã‚‡ã†ã‹	FALSE	æœˆæ¬¡è©³ç´°é‹å‹¢
```

---

## ğŸ¨ Step 6-5: ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®èª¿æ•´ï¼ˆé‡è¦ï¼‰

### ä¸€è²«æ€§ã‚’ä¿ã¤ä»•çµ„ã¿

#### ç°¡æ˜“é‹å‹¢ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®æ³¨æ„äº‹é …

```
ã€é‡è¦ãªæŒ‡ç¤ºã€‘
ãƒ»å‰æ—¥ã¯å…·ä½“çš„ãªæ—¥ä»˜ã‚’3ã¤ç¤ºã™ï¼ˆä¾‹ï¼š3æ—¥ã€15æ—¥ã€28æ—¥ï¼‰
ãƒ»å„æ—¥ã¯å…·ä½“çš„ãªæ—¥ä»˜ã‚’2ã¤ç¤ºã™ï¼ˆä¾‹ï¼š7æ—¥ã€21æ—¥ï¼‰
ãƒ»é–‹é‹ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã¯å…·ä½“çš„ã«1ã¤
ãƒ»é¿ã‘ã‚‹ã“ã¨ã‚‚å…·ä½“çš„ã«1ã¤
ãƒ»æ–­å®šçš„ã™ããªã„è¡¨ç¾ã‚’ä½¿ã†
```

#### è©³ç´°é‹å‹¢ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®æ³¨æ„äº‹é …

```
ã€é‡è¦ãªæŒ‡ç¤ºã€‘
ãƒ»ã“ã®æ–¹ã«ã¯ç°¡æ˜“é‹å‹¢ã‚‚é…ä¿¡ã•ã‚Œã¦ã„ã¾ã™
ãƒ»ç°¡æ˜“é‹å‹¢ã§ç¤ºã—ãŸå‰æ—¥ãƒ»å„æ—¥ã¨åŒã˜æ—¥ã‚’ä½¿ã†ã“ã¨
ãƒ»ãŸã ã—è©³ç´°ç‰ˆã§ã¯ã‚ˆã‚Šè©³ã—ã„èª¬æ˜ã‚’åŠ ãˆã‚‹
ãƒ»çŸ›ç›¾ã™ã‚‹å†…å®¹ã¯çµ¶å¯¾ã«å«ã‚ãªã„
ãƒ»ç°¡æ˜“ç‰ˆã®å†…å®¹ã‚’ã€Œæ·±æ˜ã‚Šã€ã™ã‚‹ã‚¤ãƒ¡ãƒ¼ã‚¸

ä¾‹ï¼š
ç°¡æ˜“ç‰ˆ: ã€Œ15æ—¥ã¯å‰æ—¥ã§ã™ã€
è©³ç´°ç‰ˆ: ã€Œ15æ—¥ã¯ç‰¹ã«ä»•äº‹é‹ãŒè‰¯ã„æ—¥ã§ã™ã€‚åˆå‰ä¸­ã«é‡è¦ãªå•†è«‡ã‚„äº¤æ¸‰ã‚’å…¥ã‚Œã‚‹ã¨è‰¯ã„ã§ã—ã‚‡ã†ã€‚ã€
```

#### ã‚ˆã‚Šé«˜åº¦ãªä¸€è²«æ€§ä¿æŒ

ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã«ç°¡æ˜“é‘‘å®šã®å†…å®¹ã‚’å«ã‚ã‚‹ï¼š

```
ã€ã“ã®æ–¹ã¸ã®ç°¡æ˜“é‹å‹¢ï¼ˆå‚è€ƒï¼‰ã€‘
{simple_fortune}

ä¸Šè¨˜ã®ç°¡æ˜“é‹å‹¢ã‚’å‰æã¨ã—ã¦ã€ã•ã‚‰ã«è©³ã—ãå ã£ã¦ãã ã•ã„ã€‚
å‰æ—¥ãƒ»å„æ—¥ã¯å¿…ãšä¸€è‡´ã•ã›ã€ã‚ˆã‚Šå…·ä½“çš„ãªè¡Œå‹•ã‚’ç¤ºã—ã¦ãã ã•ã„ã€‚
```

å®Ÿè£…ï¼š

```javascript
function generateMonthlyFortune_(userId, fortuneType, year, month) {
  // ...
  
  if (fortuneType === 'detailed') {
    // ç°¡æ˜“é‹å‹¢ã‚’å–å¾—
    const simpleFortune = getSimpleFortune_(userId, year, month);
    
    if (simpleFortune) {
      prompt = prompt.replace(/{simple_fortune}/g, simpleFortune);
    }
  }
  
  // ...
}

function getSimpleFortune_(userId, year, month) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const fortuneSheet = ss.getSheetByName('monthly_fortunes');
  
  if (!fortuneSheet) return '';
  
  const data = fortuneSheet.getDataRange().getValues();
  
  for (let i = 1; i < data.length; i++) {
    const row = data[i];
    if (row[1] === userId && row[2] === 'simple' && 
        row[3] === year && row[4] === month) {
      return row[5]; // content
    }
  }
  
  return '';
}
```

---

## ğŸ’³ Step 6-6: ã‚µãƒ–ã‚¹ã‚¯å¥‘ç´„ã®ç®¡ç†ï¼ˆ10åˆ†ï¼‰

### ã‚µãƒ–ã‚¹ã‚¯å¥‘ç´„æ™‚ã®å‡¦ç†

#### manual_payments ã§ã‚µãƒ–ã‚¹ã‚¯è¨˜éŒ²

`manual_payments` ã‚·ãƒ¼ãƒˆã«è¨˜éŒ²ã™ã‚‹éš›ï¼š

```
å•†å“å: æœˆæ¬¡è©³ç´°é‹å‹¢ï¼ˆã‚µãƒ–ã‚¹ã‚¯ï¼‰
é‡‘é¡: 2980
```

#### Code.gsã§ã‚µãƒ–ã‚¹ã‚¯åˆ¤å®š

```javascript
function handlePayPalPayment_(payload) {
  // ...æ—¢å­˜ã®å‡¦ç†...
  
  // ã‚µãƒ–ã‚¹ã‚¯å•†å“ã®å ´åˆ
  const product = getProduct_(payload.product.id);
  if (product && product.is_subscription === true) {
    // subscriptions ã‚·ãƒ¼ãƒˆã«ç™»éŒ²
    registerSubscription_(userId, payload.product.id);
  }
  
  // ...
}

function registerSubscription_(userId, productId) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  let subSheet = ss.getSheetByName('subscriptions');
  
  if (!subSheet) {
    subSheet = ss.insertSheet('subscriptions');
    subSheet.appendRow(['subscription_id', 'user_id', 'product_id', 'status', 'started_at', 'next_billing_date', 'cancelled_at']);
  }
  
  // æ—¢å­˜ã®ã‚µãƒ–ã‚¹ã‚¯ã‚’ãƒã‚§ãƒƒã‚¯
  const data = subSheet.getDataRange().getValues();
  for (let i = 1; i < data.length; i++) {
    if (data[i][1] === userId && data[i][2] === productId) {
      // ã™ã§ã«ç™»éŒ²æ¸ˆã¿ã®å ´åˆã¯ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ›´æ–°
      subSheet.getRange(i + 1, 4).setValue('active');
      return;
    }
  }
  
  // æ–°è¦ç™»éŒ²
  const subId = 'SUB_' + Utilities.getUuid();
  const now = new Date();
  const nextBillingDate = new Date(now.getFullYear(), now.getMonth() + 1, 25);
  
  subSheet.appendRow([
    subId, userId, productId, 'active', now, nextBillingDate, ''
  ]);
  
  log_(`registerSubscription_: ã‚µãƒ–ã‚¹ã‚¯ç™»éŒ² - ${subId}`);
}
```

### ã‚µãƒ–ã‚¹ã‚¯è§£ç´„å‡¦ç†

```javascript
/**
 * ã‚µãƒ–ã‚¹ã‚¯è§£ç´„
 */
function cancelSubscription(userId, productId) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const subSheet = ss.getSheetByName('subscriptions');
  
  if (!subSheet) return;
  
  const data = subSheet.getDataRange().getValues();
  
  for (let i = 1; i < data.length; i++) {
    if (data[i][1] === userId && data[i][2] === productId && data[i][3] === 'active') {
      subSheet.getRange(i + 1, 4).setValue('cancelled');
      subSheet.getRange(i + 1, 7).setValue(new Date());
      
      log_(`cancelSubscription_: è§£ç´„å‡¦ç† - ${userId}`);
      
      // è§£ç´„ç¢ºèªãƒ¡ãƒ¼ãƒ«é€ä¿¡
      addToSendQueue_(userId, 'tmpl_subscription_cancelled', {
        name: getUser_(userId).name
      }, new Date());
      
      return;
    }
  }
}
```

---

## ğŸ§ª Step 6-7: ãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼ˆ10åˆ†ï¼‰

### ãƒ†ã‚¹ãƒˆ1: æ‰‹å‹•ã§æœˆæ¬¡é…ä¿¡ã‚’å®Ÿè¡Œ

Apps Script ã‚¨ãƒ‡ã‚£ã‚¿ã§ä»¥ä¸‹ã®é–¢æ•°ã‚’å®Ÿè¡Œï¼š

```javascript
/**
 * ãƒ†ã‚¹ãƒˆç”¨ï¼šæœˆæ¬¡é…ä¿¡ã‚’å¼·åˆ¶å®Ÿè¡Œ
 */
function testMonthlyFortuneDistribution() {
  // freeze_all ã‚’ä¸€æ™‚çš„ã«ç„¡åŠ¹åŒ–
  log_('testMonthlyFortuneDistribution: ãƒ†ã‚¹ãƒˆé–‹å§‹');
  
  // å¼·åˆ¶çš„ã«é…ä¿¡å‡¦ç†ã‚’å®Ÿè¡Œ
  const now = new Date();
  const year = now.getFullYear();
  const month = now.getMonth() + 2; // ç¿Œæœˆ
  
  const subscribers = getActiveSubscribers_();
  const allUsers = getAllEmailUsers_();
  const nonSubscribers = allUsers.filter(user => {
    return !subscribers.find(sub => sub.user_id === user.user_id);
  });
  
  Logger.log('ã‚µãƒ–ã‚¹ã‚¯å¥‘ç´„è€…: ' + subscribers.length + 'äºº');
  Logger.log('éå¥‘ç´„è€…: ' + nonSubscribers.length + 'äºº');
  
  // ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«è¿½åŠ ï¼ˆå³åº§ã«å®Ÿè¡Œã•ã‚Œã‚‹ã‚ˆã†ã«ï¼‰
  distributeDetailedFortune_(subscribers, year, month);
  distributeSimpleFortune_(nonSubscribers.slice(0, 3), year, month); // æœ€åˆã®3äººã®ã¿ãƒ†ã‚¹ãƒˆ
  
  Logger.log('ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«è¿½åŠ å®Œäº†');
  Logger.log('processMonthlyFortuneSchedule_() ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„');
}
```

### ãƒ†ã‚¹ãƒˆ2: ç°¡æ˜“é‹å‹¢ç”Ÿæˆ

```javascript
/**
 * ãƒ†ã‚¹ãƒˆç”¨ï¼šç°¡æ˜“é‹å‹¢ã‚’ç”Ÿæˆ
 */
function testSimpleFortune() {
  const user = getUser_('TEST_001');
  const now = new Date();
  
  const readingId = generateMonthlyFortune_(
    'TEST_001', 
    'simple', 
    now.getFullYear(), 
    now.getMonth() + 2
  );
  
  Logger.log('ç°¡æ˜“é‹å‹¢ç”Ÿæˆå®Œäº†: ' + readingId);
  Logger.log('send_queue ã¨ monthly_fortunes ã‚·ãƒ¼ãƒˆã‚’ç¢ºèªã—ã¦ãã ã•ã„');
}
```

### ãƒ†ã‚¹ãƒˆ3: è©³ç´°é‹å‹¢ç”Ÿæˆï¼ˆã‚µãƒ–ã‚¹ã‚¯ï¼‰

```javascript
/**
 * ãƒ†ã‚¹ãƒˆç”¨ï¼šè©³ç´°é‹å‹¢ã‚’ç”Ÿæˆ
 */
function testDetailedFortune() {
  const user = getUser_('TEST_001');
  const now = new Date();
  
  const readingId = generateMonthlyFortune_(
    'TEST_001', 
    'detailed', 
    now.getFullYear(), 
    now.getMonth() + 2
  );
  
  Logger.log('è©³ç´°é‹å‹¢ç”Ÿæˆå®Œäº†: ' + readingId);
  Logger.log('send_queue ã¨ monthly_fortunes ã‚·ãƒ¼ãƒˆã‚’ç¢ºèªã—ã¦ãã ã•ã„');
}
```

âœ… ãƒ†ã‚¹ãƒˆå®Œäº†ï¼

---

## ğŸ“‹ Step 6-8: ã‚µãƒ–ã‚¹ã‚¯å¥‘ç´„è€…ã®ç™»éŒ²ï¼ˆ5åˆ†ï¼‰

### æ‰‹å‹•ã§ã‚µãƒ–ã‚¹ã‚¯ç™»éŒ²

åˆå›ã®ã‚µãƒ–ã‚¹ã‚¯å¥‘ç´„è€…ã‚’ç™»éŒ²ã™ã‚‹å ´åˆï¼š

1. `manual_payments` ã‚·ãƒ¼ãƒˆã«æ±ºæ¸ˆã‚’è¨˜éŒ²ï¼š
   ```
   å±±ç”°èŠ±å­	hanako@example.com	1990-05-15	æœˆæ¬¡è©³ç´°é‹å‹¢ï¼ˆã‚µãƒ–ã‚¹ã‚¯ï¼‰	2980	SUB_TEST_001	2025-11-25 10:00	FALSE
   ```

2. 1åˆ†å¾…ã¤

3. `subscriptions` ã‚·ãƒ¼ãƒˆã«ç™»éŒ²ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèªï¼š
   ```
   subscription_id: SUB_xxxxx
   user_id: USER_xxxxx
   product_id: PROD_SUB_001
   status: active
   next_billing_date: 2025-12-25
   ```

### ã¾ãŸã¯ã€Apps Scriptã‹ã‚‰ç›´æ¥ç™»éŒ²

```javascript
/**
 * ãƒ†ã‚¹ãƒˆç”¨ï¼šã‚µãƒ–ã‚¹ã‚¯ç™»éŒ²
 */
function testRegisterSubscription() {
  const userId = 'TEST_001';
  const productId = 'PROD_SUB_001';
  
  registerSubscription_(userId, productId);
  
  Logger.log('ã‚µãƒ–ã‚¹ã‚¯ç™»éŒ²å®Œäº†');
  Logger.log('subscriptions ã‚·ãƒ¼ãƒˆã‚’ç¢ºèªã—ã¦ãã ã•ã„');
}
```

âœ… ã‚µãƒ–ã‚¹ã‚¯ç™»éŒ²å®Œäº†ï¼

---

## ğŸ¯ å®Œäº†ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

æœˆæ¬¡é‹å‹¢é…ä¿¡ã‚·ã‚¹ãƒ†ãƒ ãŒå®Œäº†ã—ãŸã‹ç¢ºèªï¼š

- [ ] products ã‚·ãƒ¼ãƒˆã«ã‚µãƒ–ã‚¹ã‚¯å•†å“è¿½åŠ ï¼ˆPROD_SUB_001ï¼‰
- [ ] products ã‚·ãƒ¼ãƒˆã« is_subscription åˆ—è¿½åŠ 
- [ ] ai_prompts ã‚·ãƒ¼ãƒˆã«æœˆæ¬¡ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè¿½åŠ ï¼ˆMONTHLY_SIMPLE, MONTHLY_DETAILï¼‰
- [ ] email_templates ã«æœˆæ¬¡ãƒ¡ãƒ¼ãƒ«ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆè¿½åŠ 
- [ ] Code.gs ã«æœˆæ¬¡é…ä¿¡é–¢æ•°è¿½åŠ 
- [ ] tick() ã« processMonthlyFortuneDistribution_() è¿½åŠ 
- [ ] tick() ã« processMonthlyFortuneSchedule_() è¿½åŠ 
- [ ] ãƒ†ã‚¹ãƒˆå®Ÿè¡ŒæˆåŠŸ
- [ ] ç°¡æ˜“é‹å‹¢ãƒ¡ãƒ¼ãƒ«å—ä¿¡ç¢ºèª
- [ ] è©³ç´°é‹å‹¢ãƒ¡ãƒ¼ãƒ«å—ä¿¡ç¢ºèª

**ã™ã¹ã¦âœ…ãªã‚‰å®Œæˆï¼**

---

## ğŸ“Œ é‡è¦ãªè¨­å®šã¾ã¨ã‚

### é…ä¿¡ã‚¿ã‚¤ãƒŸãƒ³ã‚°

```
æ¯æœˆ25æ—¥:
- ã‚µãƒ–ã‚¹ã‚¯èª²é‡‘å‡¦ç†
- ã‚µãƒ–ã‚¹ã‚¯å¥‘ç´„è€…ã«è©³ç´°é‹å‹¢é…ä¿¡é–‹å§‹

25ï½30æ—¥:
- ã‚µãƒ–ã‚¹ã‚¯å¥‘ç´„è€…ï¼šå„ªå…ˆé…ä¿¡ï¼ˆ25ï½27æ—¥ï¼‰
- éå¥‘ç´„è€…ï¼šåˆ†æ•£é…ä¿¡ï¼ˆ25ï½30æ—¥ã€ã¾ãŸã¯æœˆåˆï¼‰

æœˆåˆã«ã‹ã‹ã£ã¦ã‚‚OK
```

### é…ä¿¡å„ªå…ˆåº¦

```
å„ªå…ˆåº¦1: ã‚µãƒ–ã‚¹ã‚¯å¥‘ç´„è€…ï¼ˆè©³ç´°é‹å‹¢ï¼‰
å„ªå…ˆåº¦2: éå¥‘ç´„è€…ï¼ˆç°¡æ˜“é‹å‹¢ï¼‰
```

### ä¸€è²«æ€§ã®ä¿æŒ

```
è©³ç´°é‹å‹¢ã¯ã€ç°¡æ˜“é‹å‹¢ã®å†…å®¹ã‚’å‚ç…§ã—ã¦ç”Ÿæˆ
â†’ å‰æ—¥ãƒ»å„æ—¥ãŒä¸€è‡´
â†’ çŸ›ç›¾ã—ãªã„
```

---

## ğŸ’° åç›Šãƒ¢ãƒ‡ãƒ«

### ã‚µãƒ–ã‚¹ã‚¯ã®é­…åŠ›

```
ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã€‘
å€‹åˆ¥é‘‘å®š: Â¥5,000/å›
   â†“
æœˆæ¬¡ã‚µãƒ–ã‚¹ã‚¯: Â¥2,980/æœˆ
   = å¹´é–“ Â¥35,760

40%ãŠå¾—ï¼ã—ã‹ã‚‚æ¯æœˆå±Šãï¼

ã€é‹å–¶ã€‘
1å›ãã‚Š: Â¥5,000
   â†“
ã‚µãƒ–ã‚¹ã‚¯: Â¥2,980 Ã— 12ãƒ¶æœˆ = Â¥35,760

7å€ã®åç›Šï¼ç¶™ç¶šèª²é‡‘ï¼
```

### åç›Šã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³

```
ã‚µãƒ–ã‚¹ã‚¯å¥‘ç´„è€…æ•°: 100äºº
æœˆé¡: Â¥2,980

æœˆé–“å£²ä¸Š: Â¥298,000
å¹´é–“å£²ä¸Š: Â¥3,576,000

OpenAI ã‚³ã‚¹ãƒˆ: ç´„Â¥6,000/æœˆ
PayPalæ‰‹æ•°æ–™: ç´„Â¥12,000/æœˆ

æœˆé–“åˆ©ç›Š: ç´„Â¥280,000
å¹´é–“åˆ©ç›Š: ç´„Â¥3,360,000

å®‰å®šåç›Šï¼
```

---

## ğŸ†˜ ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### Q: æœˆæ¬¡é…ä¿¡ãŒå®Ÿè¡Œã•ã‚Œãªã„

**å¯¾å‡¦**:
- [ ] ä»Šæ—¥ã®æ—¥ä»˜ãŒ25ï½30æ—¥ã‹ç¢ºèª
- [ ] config ã® freeze_all ãŒ FALSE ã‹ç¢ºèª
- [ ] monthly_fortune_log ã§ä»Šæ—¥å‡¦ç†æ¸ˆã¿ã«ãªã£ã¦ã„ãªã„ã‹ç¢ºèª

### Q: ç°¡æ˜“é‹å‹¢ã¨è©³ç´°é‹å‹¢ã§å‰æ—¥ãŒé•ã†

**å¯¾å‡¦**:
1. monthly_fortunes ã‚·ãƒ¼ãƒˆã§ç°¡æ˜“é‹å‹¢ã‚’ç¢ºèª
2. è©³ç´°é‹å‹¢ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã«ç°¡æ˜“é‹å‹¢ã®å†…å®¹ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
3. ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã§ã€Œå¿…ãšåŒã˜æ—¥ä»˜ã‚’ä½¿ã†ã“ã¨ã€ã¨æ˜è¨˜

### Q: ã‚µãƒ–ã‚¹ã‚¯å¥‘ç´„è€…ãŒè©³ç´°é‹å‹¢ã‚’å—ã‘å–ã‚Œãªã„

**å¯¾å‡¦**:
- [ ] subscriptions ã‚·ãƒ¼ãƒˆã§ status = active ã‹ç¢ºèª
- [ ] monthly_fortune_schedule ã§ status ã‚’ç¢ºèª
- [ ] ã‚¨ãƒ©ãƒ¼ãŒã‚ã‚‹å ´åˆã¯ãƒ­ã‚°ã‚’ç¢ºèª

---

## âœ¨ é‹ç”¨é–‹å§‹å¾Œã«ã‚„ã‚‹ã“ã¨

### æ¯æœˆ25æ—¥

```
1. PayPalç®¡ç†ç”»é¢ã§ã‚µãƒ–ã‚¹ã‚¯èª²é‡‘ã‚’ç¢ºèª
2. ã‚µãƒ–ã‚¹ã‚¯å¥‘ç´„è€…ãƒªã‚¹ãƒˆã‚’ç¢ºèªï¼ˆsubscriptions ã‚·ãƒ¼ãƒˆï¼‰
3. é…ä¿¡ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ç¢ºèªï¼ˆmonthly_fortune_schedule ã‚·ãƒ¼ãƒˆï¼‰
4. æ•°æ™‚é–“å¾Œã€send_queue ã‚’ç¢ºèª
```

### 25ï½30æ—¥ã®é–“

```
1. æ¯æ—¥ send_queue ã®ã‚¨ãƒ©ãƒ¼ç¢ºèª
2. ç°¡æ˜“é‹å‹¢ãƒ»è©³ç´°é‹å‹¢ã®é…ä¿¡çŠ¶æ³ç¢ºèª
3. ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯åé›†
```

### æœˆåˆï¼ˆ1ï½5æ—¥ï¼‰

```
1. å‰æœˆã®é…ä¿¡å®Œäº†ã‚’ç¢ºèª
2. monthly_fortune_log ã§é›†è¨ˆ
3. æ”¹å–„ç‚¹ã‚’æ´—ã„å‡ºã—
4. ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆèª¿æ•´
```

---

## ğŸ‰ å®Œæˆï¼

æœˆæ¬¡é‹å‹¢é…ä¿¡ã‚·ã‚¹ãƒ†ãƒ ãŒå®Œæˆã—ã¾ã—ãŸï¼

### ã‚·ã‚¹ãƒ†ãƒ ã®ç‰¹å¾´

```
âœ… æ¯æœˆ25ï½30æ—¥ã«è‡ªå‹•é…ä¿¡
âœ… å…¨å“¡ã«ç„¡æ–™ã®ç°¡æ˜“é‹å‹¢
âœ… ã‚µãƒ–ã‚¹ã‚¯å¥‘ç´„è€…ã«è©³ç´°é‹å‹¢
âœ… ä¸€è²«æ€§ã‚’ä¿ã¤ä»•çµ„ã¿
âœ… æœˆé¡Â¥2,980ã®ç¶™ç¶šåç›Š
âœ… å€‹åˆ¥é‘‘å®šã‚ˆã‚Š40%ãŠå¾—ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒªãƒƒãƒˆå¤§
```

### åç›Šæ§‹é€ 

```
å˜ç™ºé‘‘å®š: ãƒ•ãƒ­ãƒ¼åç›Š
ã‚µãƒ–ã‚¹ã‚¯: ã‚¹ãƒˆãƒƒã‚¯åç›Š

â†’ å®‰å®šã—ãŸç¶™ç¶šåç›Šï¼
```

---

**ã“ã‚Œã§å®Œå…¨ãªå ã„ãƒ“ã‚¸ãƒã‚¹ã‚·ã‚¹ãƒ†ãƒ ãŒå®Œæˆã—ã¾ã—ãŸï¼** ğŸŠ

**â†’ [ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ.md](./ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ.md)** ã§æœ€çµ‚ç¢ºèªï¼

