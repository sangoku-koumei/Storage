---
tags: [Architecture, System_Design, IzumiKyoka, 00]
date: 2026-01-20
source: ユニコの脳みそ/00
aliases: [ARCHITECTURE, System_Architecture]
---

[[00_知識マップ]]

# システムアーキテクチャ

占い師用LINEメールステップ配信システムの技術仕様とアーキテクチャを説明します。

---

## 概要

### システムの構成

```
┌─────────────────────────────────────────────────────────────┐
│                     ユーザー（LINE / Web）                      │
└─────────────────┬───────────────────────────────────────────┘
                  │
                  │ 申込み
                  ↓
┌─────────────────────────────────────────────────────────────┐
│                      入力層                                   │
│  ┌─────────────┐  ┌──────────────┐  ┌─────────────┐       │
│  │Google Form  │  │  Webhook     │  │  手動入力   │       │
│  └──────┬──────┘  └──────┬───────┘  └──────┬──────┘       │
└─────────┼─────────────────┼──────────────────┼──────────────┘
          │                 │                  │
          └─────────────────┴──────────────────┘
                            │
                            ↓
┌─────────────────────────────────────────────────────────────┐
│                  データ層（Googleスプレッドシート）              │
│  ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐   │
│  │ users  │ │  apps  │ │ states │ │deadlines│ │ queue  │   │
│  └────────┘ └────────┘ └────────┘ └────────┘ └────────┘   │
└─────────────────────────────────────────────────────────────┘
                            │
                            ↓
┌─────────────────────────────────────────────────────────────┐
│              処理層（Google Apps Script）                     │
│                                                               │
│  ┌────────────────────────────────────────────────────┐     │
│  │  tick() - メインループ（毎分実行）                   │     │
│  │                                                      │     │
│  │  ├─ processNewApplications_()                       │     │
│  │  │   └─ 新規申込みの判定・キュー追加                │     │
│  │  │                                                   │     │
│  │  ├─ processConsultDecisions_()                      │     │
│  │  │   └─ 相談決定・予約作成・リマインド設定         │     │
│  │  │                                                   │     │
│  │  ├─ processAppointmentReminders_()                  │     │
│  │  │   └─ リマインド処理（補助）                      │     │
│  │  │                                                   │     │
│  │  └─ processSendQueue_()                             │     │
│  │      └─ 送信キューの処理・メール送信               │     │
│  └────────────────────────────────────────────────────┘     │
└─────────────────────────────────────────────────────────────┘
                            │
                            ↓
┌─────────────────────────────────────────────────────────────┐
│                   配信層（Gmail / 外部サービス）               │
│  ┌───────────┐       ┌─────────────┐                        │
│  │   Gmail   │  or   │  SendGrid   │                        │
│  └─────┬─────┘       └──────┬──────┘                        │
└────────┼────────────────────┼────────────────────────────────┘
         │                    │
         └────────────────────┘
                  │
                  ↓
          ┌──────────────┐
          │  エンドユーザー │
          └──────────────┘
```

---

## データモデル

### ER図（主要テーブル）

```
┌─────────────┐
│   users     │
│─────────────│
│ user_id (PK)│
│ name        │
│ email       │◄───────┐
│ birth_date  │        │
│ registered  │        │
│ unsubscribed│        │
└─────────────┘        │
                       │
                       │ 1:N
                       │
┌──────────────────────┴────┐
│     applications          │
│───────────────────────────│
│ id (PK)                   │
│ user_id (FK)              │
│ type                      │
│ timestamp                 │
│ status                    │
│ accept_reject             │
│ processed                 │
└───────────────────────────┘
       │
       │ 1:1
       │
       ↓
┌──────────────────────────┐
│     deadlines            │
│──────────────────────────│
│ user_id (PK)             │
│ consult_deadline         │
│ reading_deadline         │
│ result_scheduled         │
└──────────────────────────┘

┌──────────────────────────┐
│       states             │
│──────────────────────────│
│ user_id (PK)             │
│ consult_locked           │
│ no_show_flag             │
│ purchased_course         │
└──────────────────────────┘

┌──────────────────────────┐
│     send_queue           │
│──────────────────────────│
│ id (PK)                  │
│ recipient                │
│ template_id (FK)         │
│ variables (JSON)         │
│ scheduled_at             │
│ status                   │
│ sent_at                  │
│ error_msg                │
│ is_ops                   │
└──────────────────────────┘
       │
       │ N:1
       │
       ↓
┌──────────────────────────┐
│   email_templates        │
│──────────────────────────│
│ template_id (PK)         │
│ name                     │
│ subject                  │
│ body                     │
│ is_html                  │
└──────────────────────────┘
```

---

## 処理フロー

### 1. 申込み処理フロー

```
[ユーザー申込み]
     │
     ↓
[applications シートに記録]
     │
     ↓
[tick() 実行]
     │
     ↓
[processNewApplications_()]
     │
     ├─→ [受付可否判定]
     │    │
     │    ├─ 配信停止チェック
     │    ├─ 期限チェック
     │    ├─ 重複チェック
     │    ├─ ロックチェック
     │    └─ OK / NG
     │
     ├─→ [OK の場合]
     │    │
     │    ├─ 受付メールをキューに追加
     │    ├─ 締切を設定
     │    ├─ 選定通知をスケジュール
     │    ├─ 結果メールをスケジュール
     │    └─ ステート更新
     │
     └─→ [NG の場合]
          │
          └─ ログ記録（拒否理由）
```

### 2. 無料鑑定の配信フロー

```
[申込み受付]
     │
     ↓
[即時] 受付メール送信
     │
     ↓
[翌日正午] 選定通知送信
     │
     ↓
[同日夜] 鑑定結果送信
     │    │
     │    ├─ 結果URL を含む
     │    └─ 24h限定で無料相談の再案内
     │
     └─→ [完了]
```

### 3. 無料相談の配信フロー

```
[申込み受付]
     │
     ├─→ [ユーザー宛] 候補3つ依頼メール
     │
     └─→ [運営宛] 候補到着通知
          │
          ↓
[ユーザーが候補送信]
     │
     ↓
[consult_requests に記録]
     │
     ↓
[運営が採用日時を決定]
     │
     ↓
[consult_decisions に記録]
     │
     ↓
[tick() → processConsultDecisions_()]
     │
     ├─→ appointments に予約作成
     │
     ├─→ [ユーザー宛] 予約確定通知
     │
     └─→ リマインダーをスケジュール
          │
          ├─ [前日10:00] リマインド1
          ├─ [当日-2h] リマインド2
          └─ [当日-15m] リマインド3
```

### 4. 送信キュー処理フロー

```
[tick() 実行]
     │
     ↓
[processSendQueue_()]
     │
     ├─→ send_queue から pending を抽出
     │
     ├─→ scheduled_at が過去のものを処理
     │
     ├─→ freeze_sending チェック
     │    │
     │    └─ TRUE なら運営宛以外はスキップ
     │
     ├─→ preview_mode チェック
     │    │
     │    └─ TRUE なら preview_to に転送
     │
     ├─→ テンプレート取得
     │
     ├─→ 変数置換
     │
     ├─→ メール送信（GmailApp）
     │
     └─→ ステータス更新（sent / error）
```

---

## コンポーネント設計

### 主要関数の役割

#### tick()
- **役割**: メインループ、毎分実行される
- **処理**: 4つのサブ処理を順次実行
- **エラーハンドリング**: try-catch で全体を囲み、エラー時は運営に通知

#### processNewApplications_()
- **役割**: 新規申込みの処理
- **入力**: applications シート（processed=FALSE）
- **出力**: send_queue への追加、deadlines の更新、states の更新
- **判定ロジック**: judgeApplication_() で受付可否を判定

#### processConsultDecisions_()
- **役割**: 相談決定の処理
- **入力**: consult_decisions シート（processed=FALSE）
- **出力**: appointments の作成、send_queue への追加

#### processAppointmentReminders_()
- **役割**: リマインドの補助処理
- **現状**: 使用していない（将来の拡張用）

#### processSendQueue_()
- **役割**: 送信キューの処理
- **入力**: send_queue シート（status=pending）
- **出力**: メール送信、ステータス更新
- **制御**: freeze_sending, preview_mode による送信制御

---

## セキュリティ

### 認証と権限

- **実行権限**: スプレッドシートの所有者アカウント
- **トリガー**: 所有者として実行（ユーザー権限不要）
- **Webアプリ**: デプロイ時に「自分」として実行を選択

### データ保護

- **個人情報**: スプレッドシートに保存（Googleアカウントの権限で保護）
- **アクセス制限**: スプレッドシートの共有設定で制御
- **バックアップ**: 定期的なコピー作成を推奨

### Webhook（オプション）

- **トークン検証**: `webhook_secret` で送信元を検証
- **HTTPS**: Google Apps Script は自動的にHTTPS

---

## パフォーマンス

### 実行時間

| 処理 | 平均時間 | 最大時間 |
|------|----------|----------|
| tick() | 10-30秒 | 6分（GAS制限） |
| processNewApplications_() | 1-5秒 | - |
| processConsultDecisions_() | 1-3秒 | - |
| processSendQueue_() | 5-20秒 | - |

### スケーラビリティ

| 項目 | 制限 | 備考 |
|------|------|------|
| ユーザー数 | 500万行 | スプレッドシートの行数上限 |
| 1日の送信数 | 500通 | Gmail無料版の制限 |
| トリガー実行時間 | 6分 | GASの制限 |
| 同時処理数 | 約100件 | 6分以内に処理可能な件数 |

### 最適化

- **バッチ処理**: 複数の申込みを一度に処理
- **条件フィルタ**: processed フラグで既処理をスキップ
- **ログ抑制**: 過度なログ記録を避ける
- **キャッシュ**: config の取得結果をキャッシュ（現状未実装）

---

## 拡張性

### 追加可能な機能

1. **A/Bテスト**
   - 複数のテンプレートをランダムに配信
   - 開封率・クリック率を記録

2. **配信優先度**
   - send_queue に priority 列を追加
   - 優先度順に送信

3. **外部メール配信サービス**
   - SendGrid, Mailgun 等に対応
   - sendEmail_() 関数を拡張

4. **リアルタイム通知**
   - Slack/Discord に運営通知
   - Webhook で外部システムに通知

5. **LINE Messaging API 連携**
   - LINE でメッセージ受信
   - 自動返信

6. **決済連携**
   - Stripe, PayPal 等
   - 決済完了時に自動処理

---

## 依存関係

### 必須サービス

- **Google スプレッドシート**: データストレージ
- **Google Apps Script**: 処理エンジン
- **Gmail**: メール送信

### オプション

- **SendGrid**: 大量メール配信
- **Webhook**: 外部サービスとの連携
- **LINE Messaging API**: LINE連携

### ライブラリ

GASの標準ライブラリのみ使用：
- `SpreadsheetApp`: スプレッドシート操作
- `GmailApp`: メール送信
- `Utilities`: ユーティリティ（UUID生成、日時フォーマット等）
- `ScriptApp`: トリガー管理
- `UrlFetchApp`: HTTP通信（Webhook用）
- `ContentService`: レスポンス生成（Webhook用）
- `HtmlService`: HTML生成（配信停止ページ用）

---

## 技術的な制約

### Google Apps Script の制限

| 項目 | 制限 | 影響 |
|------|------|------|
| 実行時間 | 6分/回 | 大量処理時は複数回に分割 |
| トリガー実行回数 | 20回/時 | 毎分実行 = 60回/時（問題なし） |
| UrlFetch呼び出し | 20,000回/日 | Webhook使用時に注意 |
| メール送信 | 500通/日（無料版） | 制限超過時はエラー |

### 対処法

- **実行時間**: 処理を小さく分割、processed フラグでスキップ
- **メール制限**: Google Workspace（有料）または外部サービス
- **UrlFetch制限**: 必要最小限の呼び出し

---

## デプロイメント

### 開発環境

1. Apps Scriptエディタで開発
2. `logger.log()` でデバッグ
3. テストユーザーで動作確認

### ステージング環境

1. `preview_mode=TRUE` で運用
2. `preview_to` で動作確認
3. 本番データで検証

### 本番環境

1. `preview_mode=FALSE` に変更
2. トリガーを有効化
3. 初日は密に監視

---

## モニタリング

### ログ

- **logs_[今月]**: システムログ
- **send_queue**: 送信履歴
- **Apps Script 実行数**: エラー履歴

### KPI

- **kpi_daily**: 日次集計
  - 新規登録数
  - 申込み数（種類別）
  - 送信メール数

### アラート

- **エラー通知**: `notifyOpsError_()` で運営にメール
- **送信失敗**: `send_queue` の `error_msg` を確認

---

## バージョン管理

### 推奨方法

1. **Apps Script のバージョン管理**
   - デプロイ時にバージョン番号を付与
   - 過去バージョンに復元可能

2. **Git管理（オプション）**
   - clasp を使用してGitにpush
   - GitHub/GitLab でバージョン管理

3. **変更履歴**
   - スプレッドシートの「バージョン履歴」
   - 重要な変更は名前付きバージョンを作成

---

## トラブルシューティング

### デバッグ方法

1. **ログ確認**: `logs_[今月]` シート
2. **実行数確認**: Apps Script エディタ → 実行数
3. **手動実行**: 関数を個別に実行してエラー箇所を特定
4. **Logger出力**: `Logger.log()` で中間値を確認

### よくあるエラー

| エラー | 原因 | 対処法 |
|--------|------|--------|
| TEMPLATE_NOT_FOUND | テンプレートが無い | `setupSheets()` を再実行 |
| Service invoked too many times | Gmail制限 | 翌日まで待つ、または有料プランに移行 |
| Timeout | 処理が6分超過 | 処理を分割 |
| Authorization required | 権限切れ | 再度権限を承認 |

---

## まとめ

このシステムは、以下の特徴を持つ軽量で柔軟な自動配信システムです：

- ✅ **シンプル**: スプレッドシート + GAS のみ
- ✅ **無料**: Gmail の無料枠で運用可能
- ✅ **柔軟**: カスタマイズが容易
- ✅ **安全**: プレビューモード、フリーズモード完備
- ✅ **拡張可能**: Webhook、外部サービス連携に対応

技術的な詳細や改善提案があれば、運営チームまでお知らせください。

**Happy Building! 🏗️**

