---
tags: [System_Spec, Archive, Implementation, IzumiKyoka, 00]
date: 2026-01-20
source: ユニコの脳みそ/00
aliases: [個人別アーカイブシステム_実装完了, Archive_implementation_Complete]
---

[[00_知識マップ]]

# ✅ 個人別アーカイブシステム実装完了

**3ヶ月以上前のデータを個人別に管理する新システム**

---

## 🎯 実装した内容

### 1. 毎月15日に自動アーカイブ

```
毎月15日に tick() が自動実行:
↓
3ヶ月以上前のデータを個人別アーカイブシートに移動
↓
usersシートに鑑定回数を集計・表示
↓
個人別アーカイブへのリンクを設定
```

### 2. usersシートに追加された列

```
H列: reading_count_free（無料鑑定回数）
I列: reading_count_paid（有料鑑定回数）
J列: reading_count_monthly（月次運勢回数）
K列: reading_count_total（合計鑑定回数）
L列: archive_sheet_url（個人別アーカイブへのリンク）
M列: last_reading_date（最終鑑定日）
```

**表示例**:
```
無料鑑定: 1
有料鑑定: 3
月次運勢: 12
合計: 16
アーカイブ: https://docs.google.com/...#gid=12345 ← クリックで個人別アーカイブへ
最終鑑定: 2025-11-01
```

### 3. 個人別アーカイブシート

```
シート名: user_archive_USER_001

内容:
- 3ヶ月以上前の鑑定履歴
- 鑑定タイプ（無料・有料・月次運勢）
- 鑑定結果URL
- 送信日時
- OpenAI使用トークン数
```

**自動で非表示**: シートタブは表示されませんが、リンクからアクセス可能

---

## 📊 システム構成

### 新規追加されたシート

```
28. archive_process_log - アーカイブ処理ログ
29〜. user_archive_USER_001 - 個人別アーカイブ（自動作成・非表示）
30〜. user_archive_USER_002
...
```

### 実装された関数（Code.gs）

```javascript
// メイン処理
processArchiveOn15th_() - 毎月15日に実行
archiveUserDataIndividually_() - ユーザーごとにアーカイブ

// 個人別アーカイブ
createOrUpdateUserArchive_() - 個人別アーカイブシート作成・更新
calculateUserReadingCounts_() - 鑑定回数集計
updateUserStats_() - usersシートの統計更新

// ヘルパー
getOrAddColumn_() - 列を取得・追加
getOldReadings_() - 3ヶ月以上前の鑑定データ取得
getOldMonthlyFortunes_() - 3ヶ月以上前の月次運勢取得
deleteOldReadings_() - 古いデータ削除
deleteOldMonthlyFortunes_() - 古いデータ削除

// システム
archiveSystemLogs_() - システムログのアーカイブ
isArchiveProcessedToday_() - 今日処理済みかチェック
markArchiveProcessed_() - 処理完了マーク
notifyArchiveCompleted_() - 運営に通知

// 手動実行
runArchiveNow() - Apps Scriptエディタから実行可能
```

---

## 🔄 動作フロー

### 毎月15日（自動）

```
1. tick() が実行される（毎分）
   ↓
2. 15日であることを確認
   ↓
3. 今日まだ処理していないことを確認
   ↓
4. ユーザーごとに順番に処理（最大50人/回）:
   a. 3ヶ月以上前のreadingsデータを取得
   b. 3ヶ月以上前のmonthly_fortunesデータを取得
   c. 個人別アーカイブシート作成（user_archive_USER_XXX）
   d. データをアーカイブシートに追加
   e. 元のシートから削除
   f. 鑑定回数を集計（現行＋アーカイブ）
   g. usersシートに統計情報を記録
   ↓
5. システムログをアーカイブ
   ↓
6. archive_process_log に完了記録
   ↓
7. 運営にメール通知
```

### 手動実行（任意）

Apps Script エディタで `runArchiveNow()` を実行
↓
即座にアーカイブ処理が実行される

---

## 📈 usersシートの見方

### 例

| user_id | name | email | ... | reading_count_free | reading_count_paid | reading_count_monthly | reading_count_total | archive_sheet_url | last_reading_date |
|---------|------|-------|-----|----|----|------|-------|-------------------|-------------------|
| USER_001 | 山田花子 | hanako@... | ... | 1 | 3 | 12 | 16 | [リンク](https://...) | 2025-11-01 |
| USER_002 | 佐藤太郎 | taro@... | ... | 2 | 0 | 5 | 7 | [リンク](https://...) | 2025-10-25 |

### 使い方

```
✓ 無料鑑定 + 有料鑑定 + 月次運勢 = 合計鑑定回数
✓ archive_sheet_url をクリック → 個人別アーカイブへ
✓ last_reading_date で最終利用日が分かる
✓ VIPユーザー（鑑定回数が多い人）が一目瞭然
```

---

## 🎨 個人別アーカイブシートの構造

### シート名

```
user_archive_USER_001
user_archive_USER_002
...
```

### 内容

| date | type | result_url | tokens_used | status | notes |
|------|------|------------|-------------|--------|-------|
| 2025-08-15 14:30 | 有料鑑定（詳細） | https://drive... | 2341 | archived | 個別鑑定 |
| 2025-09-25 10:00 | 月次運勢(detailed) | | 1523 | archived | 2025年10月 |
| 2025-10-01 09:15 | 有料鑑定（基本） | https://drive... | 1456 | archived | 個別鑑定 |

**特徴**:
- 時系列で並んでいる
- 鑑定タイプが分かる
- 鑑定結果URLにアクセス可能
- OpenAI使用量も記録

---

## 💡 実務での使い方

### ユーザー管理

```
1. usersシートを開く
2. 鑑定回数の列でソート
3. VIPユーザー（回数が多い人）を確認
4. 特別オファーの対象者を選定
```

### 個別確認

```
1. usersシートで該当ユーザーを探す
2. archive_sheet_url をクリック
3. 個人別アーカイブを表示
4. 過去の鑑定履歴を確認
```

### システム監視

```
1. archive_process_log シートを開く
2. 毎月15日に処理されているか確認
3. users_processed, readings_archived を確認
4. status が completed か確認
```

---

## 🔧 テスト方法

### テスト1: 鑑定回数集計

Apps Script エディタで実行:

```javascript
function testCountReadings() {
  const userId = 'TEST_001';
  const counts = calculateUserReadingCounts_(userId);
  Logger.log(JSON.stringify(counts));
  
  // 結果例:
  // {
  //   free: 1,
  //   paid: 3,
  //   monthly: 12,
  //   total: 16,
  //   lastDate: 2025-11-01
  // }
}
```

### テスト2: 個人別アーカイブ作成

```javascript
function testCreateArchive() {
  const userId = 'TEST_001';
  const result = createOrUpdateUserArchive_(userId);
  Logger.log('アーカイブシートID: ' + result.archiveSheetId);
  Logger.log('鑑定件数: ' + result.readingsCount);
  Logger.log('運勢件数: ' + result.fortunesCount);
}
```

### テスト3: 手動アーカイブ実行

```javascript
function testFullArchive() {
  runArchiveNow();
}
```

または、メニューから:
```
ツール → マクロ → runArchiveNow
```

---

## 🎯 効果

### メインシートが軽量に

```
Before:
readings: 5,000行（全履歴）
monthly_fortunes: 3,000行（全履歴）
→ 重い、遅い

After:
readings: 500行（3ヶ月分のみ）
monthly_fortunes: 300行（3ヶ月分のみ）
→ 軽い、高速
```

### ユーザー管理が簡単に

```
Before:
- 誰が何回鑑定を受けたか不明
- 履歴を見るにはreadingsシートを全検索

After:
- usersシートで一目瞭然
- 個人別アーカイブへ1クリック
- VIPユーザーがすぐ分かる
```

### データは保持

```
✓ 3ヶ月以上前のデータは削除されない
✓ 個人別アーカイブシートに保管
✓ いつでもアクセス可能
✓ 過去の全履歴が見られる
```

---

## 📅 運用カレンダー

```
毎月1日:
- 新しいlogsシート作成（logs_2025-12など）

毎月15日:
- 個人別アーカイブ自動実行⭐NEW
- 3ヶ月以上前のデータを個人別に移動
- usersシートの統計更新
- 運営にメール通知

毎月25日:
- サブスク課金処理
- 月次運勢配信開始

25～30日:
- 月次運勢配信継続
```

---

## 🆘 トラブルシューティング

### Q: アーカイブが実行されない

**確認**:
- [ ] 今日は15日か？
- [ ] archive_process_log で今日処理済みでないか？
- [ ] config の freeze_all が FALSE か？
- [ ] トリガーが設定されているか？

### Q: usersシートに統計が表示されない

**対処**:
1. `runArchiveNow()` を手動実行
2. usersシートを確認
3. 列が追加されているか確認

### Q: 個人別アーカイブシートが見つからない

**対処**:
1. シート一覧で `user_archive_` で検索
2. 非表示になっているので、表示する:
   - シートタブを右クリック → 「非表示のシートを表示」
   - `user_archive_USER_001` を選択 → 表示
3. または、usersシートのリンクからアクセス

### Q: アーカイブ処理が6分でタイムアウト

**対処**:
Code.gsの `archiveUserDataIndividually_()` で調整:

```javascript
const maxUsersPerRun = 50; // 50 → 30 に変更
```

→ 1回の処理を少なくして、複数回に分散

---

## 📝 チェックリスト

- [ ] Code.gsに個人別アーカイブ関数を追加
- [ ] setupSheets()にarchive_process_logを追加
- [ ] tick()でprocessArchiveOn15th_()を呼び出し
- [ ] テスト実行成功
- [ ] usersシートに統計列が追加された
- [ ] 個人別アーカイブシートが作成された
- [ ] リンクをクリックでアーカイブに遷移できた
- [ ] 15日に自動実行されることを確認

---

## ✨ 完成！

**すべて実装完了しました！**

### システムの全機能

```
✅ 個別鑑定（6種類）
✅ 月次運勢配信（3種類）
✅ PayPal決済自動処理
✅ OpenAI自動鑑定
✅ 個人別アーカイブ⭐NEW
✅ 鑑定回数集計⭐NEW
✅ データ軽量化⭐NEW
```

### ファイル構成

```
【ドキュメント】
1. GAS実装仕様書.md ← 技術仕様（開発者向け）⭐NEW
2. 個人別アーカイブシステム_実装完了.md ← 本ファイル⭐NEW

【コード】
3. Code.gs（3,520行） - 個人別アーカイブ実装済み⭐
```

---

**次の15日に自動実行されます！**

手動テストは `runArchiveNow()` で可能です。

**あなたのビジネスの成功を心よりお祈りしています！** 🌟🔮✨

