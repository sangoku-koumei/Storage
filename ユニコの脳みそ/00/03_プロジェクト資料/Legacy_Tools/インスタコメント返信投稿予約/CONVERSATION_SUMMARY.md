#ToolDev #DevLog #ConversationSummary

# 開発の経緯と議論のまとめ

## 📌 プロジェクトの経緯

### 最初のリクエスト
ユーザーは「ElgramやIstepのようなインスタ自動投稿・自動返信のツールを自作することは可能か？」と質問。

**背景**:
- Elgramが来年から有料化
- Elgram: 22,000円/月、Istep: 33,000円/月
- 1アカウントあたりの料金なので、複数アカウントで2倍・3倍と費用が増加

**目的**:
1. 自分で複数アカウントを使用できるツールを自作
2. Elgram利用者が有料化するタイミングで、安い値段で提供できるなら利用者が見つかりそう
3. できるだけ性能が良いツールを制作したい

### 開発方針の決定
- **自分で開発が前提**
- **Python版で土台となるコードを議論して考える**
- **今回の土台を元に議論しながら機能を追加**
- **さらに議論して実際に必要になる機能を追加**

---

## 🎯 機能要件の議論過程

### 初期要件
1. **フィード投稿**
2. **リール投稿**
3. **ストーリーズ投稿**
4. **コメント返信**
5. **DM**
6. **テンプレート作成**

### 追加要件（議論を通じて）
1. **デバッグモードの追加**
2. **ログの保管**
3. **GoogleスプレッドシートやGASとの連携**

### 実務レベルの要件
1. **見やすく使いやすいUI**
   - 操作性: マウス操作や選択、ドラッグ&ドロップでの操作をメインに考える
   - 画面設計: どの画面の時に何を表示するべきか、何は表示しなくて良いか

### Phase 1への統合
最初は「Phase 2」として除外されていた機能を、すべて「Phase 1」に含めることを決定：

1. **DM自動返信**
   - UserConversation + 24時間ルール判定（can_auto_reply()）
   - DMLog / DMReplyRule を Comment系と同じパターンで実装

2. **テンプレート／ルール高度化**
   - MessageTemplate（comment/dm/caption）
   - ルール優先度（priority）＆ドラッグ並び替え
   - ルールテストAPI（どのルールがマッチするか）

3. **投稿種別拡張**
   - post_type='reel' / 'story'
   - media_type='video'
   - meta_clientのパラメータを調整

4. **ログ／レポート／連携**
   - AppEventLog にシステムイベントを保存
   - ログ画面
   - Googleスプレッドシート連携（レポート出力）

---

## 💭 設計思想・考え方の議論

### データベース設計
- **正規化**: アカウント、投稿、ルール、ログを適切に分離
- **履歴管理**: コメント・DMの受信履歴をすべて保存
- **状態管理**: 投稿状態、会話状態を明確に管理
- **拡張性**: 将来的な機能追加に対応できる設計

### UI/UX設計
- **マウス操作中心**: キーボード操作を最小限に
- **ドラッグ&ドロップ**: 直感的な操作
- **情報の階層化**: 必要な情報だけを表示
- **認知負荷の軽減**: 画面ごとに明確な目的

### ログ・デバッグ設計
- **二重記録**: PythonロガーとDBの`AppEventLog`の両方に記録
- **構造化**: イベントタイプ、ソース、メタデータを構造化
- **デバッグモード**: 開発時のみ詳細ログを出力

### セキュリティ設計
- **アクセストークン**: 現在は平文保存（本番環境では暗号化推奨）
- **環境変数**: 機密情報は`.env`で管理
- **Webhook検証**: MetaからのWebhookを検証

---

## 🔧 技術的な議論

### Meta Graph API
- **公式API使用**: Meta Graph API & Messenger API for Instagram
- **OAuth**: アクセストークンの取得とリフレッシュ
- **Webhooks**: Metaからのイベント通知

### アーキテクチャ
- **FastAPI**: Python Webフレームワーク
- **SQLAlchemy**: ORM
- **APScheduler**: バックグラウンドジョブ
- **Pydantic**: データバリデーション

### 外部連携
- **Google Sheets API**: サービスアカウントを使用
- **Google Apps Script (GAS)**: 将来的な連携オプション

---

## ⚠️ 注意点・重要ポイントの議論

### Meta Graph API関連
1. **Webhookペイロード構造**: 実際のMeta APIのペイロード構造に合わせて調整が必要
2. **アクセストークン有効期限**: リフレッシュトークンで更新する仕組みが必要
3. **レート制限**: API呼び出し頻度に注意
4. **権限**: 必要な権限を適切にリクエスト

### DM 24時間ルール
1. **厳守必須**: 24時間ルール違反はアカウント停止のリスク
2. **会話状態管理**: `UserConversation`で最後のメッセージ時刻を追跡
3. **自動返信判定**: `can_auto_reply()`で厳密に判定

### セキュリティ
1. **アクセストークン暗号化**: 本番環境では必須
2. **環境変数管理**: `.env`ファイルをGitにコミットしない
3. **Webhook検証**: MetaからのWebhookを検証

### データベース
1. **タイムゾーン**: すべてUTCで保存、表示時に変換
2. **重複防止**: Webhookの重複送信に対応（`instagram_comment_id`、`message_id`でユニーク制約）
3. **マイグレーション**: Alembicを使用したスキーマ変更管理（将来実装）

### ログ・デバッグ
1. **個人情報**: デバッグモードでも個人情報をログに出力しない
2. **ログローテーション**: ファイルサイズ制限とローテーション
3. **ログレベル**: 本番環境ではINFO以上のみ

---

## 🎨 UI/UXの詳細議論

### 画面ごとの設計思想

#### ダッシュボード
- **表示**: アカウント数、予約投稿数、未処理コメント/DM数
- **非表示**: 詳細なログ、個別の投稿内容

#### カレンダー画面
- **表示**: 月次カレンダー、投稿予定一覧、投稿状態（色分け）
- **操作**: ドラッグ&ドロップでスケジュール変更、クリックで詳細表示
- **非表示**: キャプション全文、メディアURL

#### インボックス（コメント）
- **表示**: 未返信/返信済みコメント一覧、コメント内容、送信者、時刻、使用ルール
- **操作**: クリックで詳細表示、手動返信ボタン、ステータス更新
- **非表示**: 技術的なID、内部ログ

#### インボックス（DM）
- **表示**: 未返信/返信済みDM一覧、DM内容、送信者、時刻、24時間ルール状態、使用ルール
- **操作**: クリックで会話履歴表示、手動返信ボタン、ステータス更新
- **非表示**: 技術的なID、内部ログ

#### ルール管理画面
- **表示**: ルール一覧（優先度順）、キーワード、返信テキスト、テンプレート、有効/無効状態
- **操作**: ドラッグ&ドロップで優先度変更、ルール作成・編集・削除、ルールテスト
- **非表示**: 内部ID、作成日時（必要に応じて表示）

#### テンプレート管理画面
- **表示**: テンプレート一覧（種別別）、テンプレート名、本文、種別、有効/無効状態
- **操作**: テンプレート作成・編集・削除、種別フィルタ
- **非表示**: 内部ID、作成日時（必要に応じて表示）

#### ログ画面
- **表示**: アプリケーションイベントログ一覧、レベル、ソース、イベントタイプ、メッセージ、時刻
- **操作**: レベルフィルタ、ソースフィルタ、期間フィルタ
- **非表示**: 技術的なメタデータ（必要に応じて展開）

#### 設定画面
- **表示**: アカウント一覧、アカウント名、状態、接続状態
- **操作**: アカウント追加（OAuth認証）、アカウント有効/無効切り替え、アカウント削除
- **非表示**: アクセストークン、技術的なID

---

## 📊 実装の段階的アプローチ

### 議論の結果、Phase 1を以下のステップに分割：

1. **予約投稿＋カレンダー**
   - 基本的な投稿機能とスケジューラー
   - カレンダー表示API

2. **コメント自動返信＋インボックス**
   - コメントWebhook処理
   - 自動返信ロジック
   - インボックスAPI

3. **DM自動返信＋インボックス**
   - DM Webhook処理
   - 24時間ルール実装
   - インボックスAPI

4. **テンプレート／ルール高度化**
   - テンプレート管理
   - 優先度管理
   - ルールテスト

5. **投稿種別拡張**
   - Reel/Story対応
   - 動画対応

6. **AppEventLog＋ログ画面＋Sheets連携**
   - イベントログ実装
   - Google Sheets連携

---

## 🔄 将来の拡張案（議論されたが未実装）

1. **OAuth認証フロー**: アクセストークン取得の自動化
2. **バッチ処理**: 大量データの一括処理
3. **レポート機能**: 統計・分析機能の強化
4. **通知機能**: エラーや重要なイベントの通知
5. **マルチユーザー**: 複数ユーザーでの利用
6. **APIレート制限管理**: 自動的なレート制限対応
7. **A/Bテスト**: 返信メッセージの効果測定
8. **コメントにも24時間ルールを適用**: ユーザーごとのやり取り履歴として拡張

---

## 📝 実装時の注意点（議論で出たポイント）
- **Date**: 2024年
- **Status**: Finalized

---

## 関連リンク
- [[PROJECT_DESIGN]]
- [[TOOL_DESCRIPTION]]
- [[FEATURES]]
- [[技術資産__インスタコメント返信投稿予約ツール]]
- [[2025-12-15-ツール作成アイデア]]
- [[2026-01-13_ツール開発・改善知見バイブル_深層対話]]
- [[00 Rules]]

### Webhook処理
- **重複イベント**: MetaがWebhookを再送信する可能性があるため、重複チェックが必要
- **ペイロード構造**: 実際のMeta APIのペイロード構造を確認して調整が必要

### エラーハンドリング
- **Meta APIエラー**: 適切にキャッチしてログに記録
- **状態管理**: エラー時は`failed`ステータスに変更

### パフォーマンス
- **大量データ**: ページネーション対応
- **スケジューラー**: 1分ごとのチェックで十分

### テスト
- **ユニットテスト**: スケジューラー、ルールマッチングなど
- **統合テスト**: Webhook処理、API呼び出しなど

---

## 🎯 成功指標（議論で設定）

1. **機能完成度**: Phase 1の全機能が動作する
2. **安定性**: 24時間ルール違反なし、エラー率1%以下
3. **パフォーマンス**: 投稿処理が1分以内、API応答が500ms以内
4. **使いやすさ**: 直感的なUI、操作説明不要

---

## 📚 参考にした技術・ツール

- **Meta Graph API**: Instagram公式API
- **FastAPI**: モダンなPython Webフレームワーク
- **SQLAlchemy**: 強力なORM
- **APScheduler**: バックグラウンドジョブスケジューラー
- **Pydantic**: 型安全なデータバリデーション
- **Google Sheets API**: レポート出力用

---

## 💡 重要な設計判断

### 1. すべての機能をPhase 1に含める
- 最初は段階的に実装する予定だったが、ユーザーの要望で全機能をPhase 1に統合

### 2. 24時間ルールの厳密な実装
- DM自動返信の安全性を最優先
- `UserConversation`テーブルで会話状態を管理

### 3. 二重ログシステム
- PythonロガーとDBの`AppEventLog`の両方に記録
- デバッグと監視の両方に対応

### 4. テンプレートとルールの分離
- テンプレートを独立したエンティティとして管理
- ルールでテンプレートを参照可能に

### 5. 優先度ベースのルールマッチング
- 複数ルールがマッチする場合、優先度の高いものを適用
- ドラッグ&ドロップで優先度を変更可能

---

**このドキュメントは、プロジェクトの全体的な設計思想と議論の経緯を記録したものです。**


