# Instagram自動投稿・自動返信ツール -#ToolDev #SystemDesign #FastAPI #PostgreSQL #Architecture
# プロジェクトの設計思想と技術的な詳細

## 📋 プロジェクトの目的

### 背景
- **Elgram**や**Istep**のような既存ツールが高額（Elgram: 22,000円/月、Istep: 33,000円/月）
- 複数アカウント運用で費用が2倍・3倍と増加
- Elgramが来年から有料化予定のため、代替ツールの需要が見込める

### 目標
1. **個人利用**: 自分で複数アカウントを運用できるツールを自作
2. **商用展開**: Elgram利用者が有料化するタイミングで、安価な代替ツールとして提供
3. **機能充実**: 既存ツールと同等以上の性能を実現

---

## 🎯 実装したい機能一覧

### Phase 1（全機能を含む）

#### 1. 予約投稿機能
- **Feed投稿**: 画像・動画の予約投稿
- **Version**: 1.0.0
- **Status**: Stable
- **Reel投稿**: 動画の予約投稿
- **Story投稿**: 画像・動画の予約投稿
- **カレンダー表示**: 投稿スケジュールの視覚化
- **スケジュール変更**: ドラッグ&ドロップで予約時間を変更
- **投稿状態管理**: pending, processing, posted, failed, canceled, paused

#### 2. コメント自動返信
- **キーワードベース**: コメント内容に含まれるキーワードで自動返信
- **優先度設定**: 複数ルールの優先順位を設定可能
- **テンプレート連携**: メッセージテンプレートを使用可能
- **ルールテスト**: どのルールがマッチするかテスト機能
- **インボックス**: 未返信・返信済みコメントの一元管理

#### 3. DM自動返信
- **キーワードベース**: DM内容に含まれるキーワードで自動返信
- **24時間ルール**: ユーザーからの最後のメッセージから24時間以内のみ自動返信可能
- **優先度設定**: 複数ルールの優先順位を設定可能
- **テンプレート連携**: メッセージテンプレートを使用可能
- **ルールテスト**: どのルールがマッチするかテスト機能
- **インボックス**: 未返信・返信済みDMの一元管理
- **会話状態管理**: ユーザーごとの会話履歴と24時間ルール判定

#### 4. テンプレート管理
- **種別**: コメント用、DM用、キャプション用
- **テンプレート作成・編集・削除**
- **ルールとの連携**: ルールでテンプレートを参照可能

#### 5. ログ・デバッグ機能
- **アプリケーションイベントログ**: システムイベントの記録
- **デバッグモード**: 詳細なリクエストログ出力
- **ログファイル**: ローテーション付きファイルログ
- **ログ画面**: イベントログの閲覧

#### 6. Google Sheets連携
- **ログエクスポート**: アプリケーションイベントログをスプレッドシートに出力
- **レポート機能**: データ分析用のデータ出力

---

## 💡 技術的な考え方・設計方針

### アーキテクチャ
- **バックエンド**: Python + FastAPI
- **データベース**: SQLAlchemy ORM（SQLite/PostgreSQL対応）
- **スケジューラー**: APScheduler（バックグラウンドジョブ）
- **API**: Meta Graph API（Instagram Graph API）

### データベース設計の考え方
1. **正規化**: アカウント、投稿、ルール、ログを適切に分離
2. **履歴管理**: コメント・DMの受信履歴をすべて保存
3. **状態管理**: 投稿状態、会話状態を明確に管理
4. **拡張性**: 将来的な機能追加に対応できる設計

### セキュリティの考え方
1. **アクセストークン**: 現在は平文保存（本番環境では暗号化推奨）
2. **環境変数**: 機密情報は`.env`で管理
3. **Webhook検証**: MetaからのWebhookを検証

### エラーハンドリングの考え方
1. **例外処理**: Meta APIエラーを適切にキャッチ
2. **ログ記録**: すべてのエラーをログに記録
3. **状態管理**: エラー時は`failed`ステータスに変更

### ログの考え方
1. **二重記録**: PythonロガーとDBの`AppEventLog`の両方に記録
2. **構造化**: イベントタイプ、ソース、メタデータを構造化
3. **デバッグモード**: 開発時のみ詳細ログを出力

---

## 🎨 UI/UXの考え方

### 基本方針
- **マウス操作中心**: キーボード操作を最小限に
- **ドラッグ&ドロップ**: 直感的な操作
- **情報の階層化**: 必要な情報だけを表示
- **認知負荷の軽減**: 画面ごとに明確な目的

### 主要画面の設計思想

#### 1. ダッシュボード
- **表示内容**:
  - アカウント数（総数・有効数）
  - 予約投稿数（全体・今日）
  - 未処理コメント数
  - 未処理DM数
- **非表示**: 詳細なログ、個別の投稿内容

#### 2. カレンダー画面
- **表示内容**:
  - 月次カレンダー表示
  - 投稿予定の一覧（日付・時間・アカウント・種別）
  - 投稿状態（色分け）
- **操作**:
  - ドラッグ&ドロップでスケジュール変更
  - クリックで詳細表示・編集
- **非表示**: キャプション全文、メディアURL

#### 3. インボックス（コメント）
- **表示内容**:
  - 未返信コメント一覧
  - 返信済みコメント一覧（フィルタ可能）
  - コメント内容、送信者、時刻
  - 使用されたルール
- **操作**:
  - クリックで詳細表示
  - 手動返信ボタン
  - ステータス更新（unhandled → done）
- **非表示**: 技術的なID、内部ログ

#### 4. インボックス（DM）
- **表示内容**:
  - 未返信DM一覧
  - 返信済みDM一覧（フィルタ可能）
  - DM内容、送信者、時刻
  - 24時間ルール状態（自動返信可能/不可能）
  - 使用されたルール
- **操作**:
  - クリックで会話履歴表示
  - 手動返信ボタン
  - ステータス更新
- **非表示**: 技術的なID、内部ログ

#### 5. ルール管理画面
- **表示内容**:
  - ルール一覧（優先度順）
  - キーワード、返信テキスト、テンプレート
  - 有効/無効状態
- **操作**:
  - ドラッグ&ドロップで優先度変更
  - ルール作成・編集・削除
  - ルールテスト（テキスト入力でマッチング確認）
- **非表示**: 内部ID、作成日時（必要に応じて表示）

#### 6. テンプレート管理画面
- **表示内容**:
  - テンプレート一覧（種別別）
  - テンプレート名、本文、種別
  - 有効/無効状態
- **操作**:
  - テンプレート作成・編集・削除
  - 種別フィルタ
- **非表示**: 内部ID、作成日時（必要に応じて表示）

#### 7. ログ画面
- **表示内容**:
  - アプリケーションイベントログ一覧
  - レベル、ソース、イベントタイプ、メッセージ
  - 時刻
- **操作**:
  - レベルフィルタ（ERROR, WARN, INFO, DEBUG）
  - ソースフィルタ
  - 期間フィルタ
- **非表示**: 技術的なメタデータ（必要に応じて展開）

#### 8. 設定画面
- **表示内容**:
  - アカウント一覧
  - アカウント名、状態、接続状態
- **操作**:
  - アカウント追加（OAuth認証）
  - アカウント有効/無効切り替え
  - アカウント削除
- **非表示**: アクセストークン、技術的なID

---

## 📊 実装の優先順位

### Phase 1（全機能実装）

#### ステップ1: 予約投稿＋カレンダー
- [x] データベースモデル（IGAccount, ScheduledPost）
- [x] Meta APIクライアント（create_media_for_post, publish_media）
- [x] スケジューラー（APScheduler）
- [x] APIエンドポイント（CRUD、カレンダー表示）
- [ ] フロントエンド（カレンダーUI）

#### ステップ2: コメント自動返信＋インボックス
- [x] データベースモデル（CommentReplyRule, CommentLog）
- [x] Webhookハンドラー（コメント受信）
- [x] 自動返信ロジック（キーワードマッチング、優先度）
- [x] APIエンドポイント（ルールCRUD、インボックス）
- [ ] フロントエンド（ルール管理、インボックスUI）

#### ステップ3: DM自動返信＋インボックス
- [x] データベースモデル（DMReplyRule, DMLog, UserConversation）
- [x] 24時間ルール判定（can_auto_reply）
- [x] Webhookハンドラー（DM受信）
- [x] 自動返信ロジック（キーワードマッチング、24時間ルール）
- [x] APIエンドポイント（ルールCRUD、インボックス）
- [ ] フロントエンド（ルール管理、インボックスUI）

#### ステップ4: テンプレート／ルール高度化
- [x] データベースモデル（MessageTemplate）
- [x] テンプレート連携（ルールでテンプレート参照）
- [x] 優先度管理（ドラッグ&ドロップ用API）
- [x] ルールテストAPI
- [ ] フロントエンド（テンプレート管理、優先度変更UI）

#### ステップ5: 投稿種別拡張
- [x] データベースモデル拡張（post_type, media_type）
- [x] Meta APIクライアント拡張（Feed/Reel/Story対応）
- [x] バリデーション（投稿種別ごとの必須項目）
- [ ] フロントエンド（投稿種別選択UI）

#### ステップ6: AppEventLog＋ログ画面＋Sheets連携
- [x] データベースモデル（AppEventLog）
- [x] ログユーティリティ（log_event）
- [x] ログ設定（ファイルログ、ローテーション）
- [x] Google Sheets連携（エクスポート機能）
- [x] APIエンドポイント（ログ一覧）
- [ ] フロントエンド（ログ画面UI）

---

## ⚠️ 注意点・重要ポイント

### Meta Graph API関連
1. **Webhookペイロード構造**: 実際のMeta APIのペイロード構造に合わせて調整が必要
2. **アクセストークン有効期限**: リフレッシュトークンで更新する仕組みが必要
3. **レート制限**: API呼び出し頻度に注意
4. **権限**: 必要な権限を適切にリクエスト

### DM 24時間ルール
1. **厳守必須**: 24時間ルール違反はアカウント停止のリスク
2. **会話状態管理**: `UserConversation`で最後のメッセージ時刻を追跡
3. **自動返信判定**: `can_auto_reply()`で厳密に判定

### セキュリティ
1. **アクセストークン暗号化**: 本番環境では必須
2. **環境変数管理**: `.env`ファイルをGitにコミットしない
3. **Webhook検証**: MetaからのWebhookを検証

### データベース
1. **タイムゾーン**: すべてUTCで保存、表示時に変換
2. **重複防止**: Webhookの重複送信に対応（`instagram_comment_id`、`message_id`でユニーク制約）
3. **マイグレーション**: Alembicを使用したスキーマ変更管理（将来実装）

### ログ・デバッグ
1. **個人情報**: デバッグモードでも個人情報をログに出力しない
2. **ログローテーション**: ファイルサイズ制限とローテーション
3. **ログレベル**: 本番環境ではINFO以上のみ

### UI/UX
1. **レスポンシブ**: モバイル対応も考慮
2. **パフォーマンス**: 大量データのページネーション
3. **エラーメッセージ**: ユーザーに分かりやすいエラーメッセージ

---

## 🔄 将来の拡張案

### Phase 2以降の検討事項
1. **OAuth認証フロー**: アクセストークン取得の自動化
2. **バッチ処理**: 大量データの一括処理
3. **レポート機能**: 統計・分析機能の強化
4. **通知機能**: エラーや重要なイベントの通知
5. **マルチユーザー**: 複数ユーザーでの利用
6. **APIレート制限管理**: 自動的なレート制限対応
7. **A/Bテスト**: 返信メッセージの効果測定

---

## 関連リンク
- [[TOOL_DESCRIPTION]]
- [[FEATURES]]
- [[2025-12-15-ツール作成アイデア]]
- [[2025-12-17-ツール展開メモ]]
- [[在宅ワーク考察]]
- [[00 Rules]]
- [[2026-01-13_ツール開発・改善知見バイブル_深層対話]]

---

## 📝 技術スタック

### バックエンド
- **Python 3.10+**
- **FastAPI**: Webフレームワーク
- **SQLAlchemy**: ORM
- **APScheduler**: スケジューラー
- **Pydantic**: データバリデーション
- **requests**: HTTPクライアント

### データベース
- **SQLite**: 開発環境（デフォルト）
- **PostgreSQL**: 本番環境推奨

### 外部連携
- **Meta Graph API**: Instagram API
- **Google Sheets API**: レポート出力（オプション）

### 開発ツール
- **pytest**: テストフレームワーク
- **Alembic**: データベースマイグレーション（将来実装）

---

## 🎯 成功指標

1. **機能完成度**: Phase 1の全機能が動作する
2. **安定性**: 24時間ルール違反なし、エラー率1%以下
3. **パフォーマンス**: 投稿処理が1分以内、API応答が500ms以内
4. **使いやすさ**: 直感的なUI、操作説明不要

---

## 📚 参考資料

- [Meta Graph API Documentation](https://developers.facebook.com/docs/instagram-api)
- [FastAPI Documentation](https://fastapi.tiangolo.com/)
- [SQLAlchemy Documentation](https://docs.sqlalchemy.org/)
- [APScheduler Documentation](https://apscheduler.readthedocs.io/)

---

**最終更新**: 2024年（実装開始時点）
**バージョン**: 1.0.0（Phase 1）


