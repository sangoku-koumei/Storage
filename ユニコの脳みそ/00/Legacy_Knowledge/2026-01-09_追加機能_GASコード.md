---
tags: [SNS運用, 自動化, GAS, CodeSnippet, Research, DALL-E3, Reporting, 00, Legacy_Knowledge]
date: 2026-01-09
source: Implementation_Code
aliases: [GAS_Addon_Features, GAS追加機能コード]
---

# [[2026-01-09_追加機能_GASコード]]
# 追加機能実装コード (GAS編)

[[00_知識マップ|⬅️ 00：知識マップへ戻る]]

## Keywords & Tags
#SNS運用 #自動化 #GAS #CodeSnippet #Research #DALL-E3 #Reporting #Legacy_Knowledge #00

スプレッドシートの「拡張機能 > Apps Script」を開き、以下のコードを追加してください。
`SNS自動化_GAS版.js` の末尾に追加するのがおすすめです。

---

## 1. 競合リサーチ自動化機能 (`runResearch`)

「いきなり投稿作成」ではなく、まずは市場調査を行うための機能です。
指定したキーワード（ジャンル）について、AIが3C分析・SWOT分析を行い、別シートに出力します。

```javascript
/**
 * 6. 競合リサーチ実行
 * 指定した「ターゲットキーワード」に基づき、AIに分析を行わせ、[Research]シートに出力します。
 */
function runResearch() {
  const ui = SpreadsheetApp.getUi();
  const keyword = ui.prompt('競合リサーチ', 'ターゲットとなる「ジャンル・キーワード」を入力してください\n(例: インスタ運用代行, ダイエットサプリ)', ui.ButtonSet.OK_CANCEL).getResponseText();
  
  if (!keyword) return;

  ui.alert('リサーチを開始します。30秒ほどお待ちください...');

  // AIへの指示（プロンプト）
  const systemPrompt = `あなたはプロのマーケターです。以下のジャンルにおける「競合分析（3C分析）」を行い、結果を出力してください。
  
  # ジャンル
  ${keyword}

  # 出力フォーマット
  - 市場規模・トレンド: (200文字以内)
  - 競合の強み (Competitor): (箇条書き3点)
  - 顧客の悩み (Customer): (箇条書き3点)
  - 自社が狙うべきポジション (Company): (具体的提案)
  - 差別化のヒント: (一言)
  `;

  // GPT-4oを呼び出し (既存のcallGPT関数を利用)
  const result = callGPT(systemPrompt, "分析結果を簡潔にまとめてください。");

  // 出力先シート作成
  let sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Research");
  if (!sheet) {
    sheet = SpreadsheetApp.getActiveSpreadsheet().insertSheet("Research");
    sheet.appendRow(["日時", "キーワード", "分析結果"]);
  }

  // 結果を書き込み
  sheet.appendRow([new Date(), keyword, result]);
  
  // 見やすく調整
  sheet.getRange(sheet.getLastRow(), 3).setWrapStrategy(SpreadsheetApp.WrapStrategy.WRAP);
  sheet.setColumnWidth(3, 500);

  ui.alert('リサーチ完了', '[Research]シートを確認してください。', ui.ButtonSet.OK);
}
```

---

## 2. DALL-E 3 完全自動画像生成 (`generateDalleImages`)

Canvaを使わず、AIに画像を生成させてGoogleドライブに保存する「完全手離れモード」です。

```javascript
/**
 * 7. DALL-E 3 画像生成
 * シートの「Image Prompt」列を読み、画像を生成してGoogleドライブに保存し、URLを記入します。
 */
function generateDalleImages() {
  const ui = SpreadsheetApp.getUi();
  
  // フォルダID確認
  const folderIdResponse = ui.prompt('画像保存先', 'GoogleドライブのフォルダIDを入力:', ui.ButtonSet.OK_CANCEL);
  if (folderIdResponse.getSelectedButton() != ui.Button.OK) return;
  const folderId = folderIdResponse.getResponseText();

  const sheet = SpreadsheetApp.getActiveSheet();
  const rows = sheet.getDataRange().getValues();
  const folder = DriveApp.getFolderById(folderId);

  // ヘッダー行を除く
  for (let i = 1; i < rows.length; i++) {
    const prompt = rows[i][4]; // E列: Image Prompt
    const existingUrl = rows[i][5]; // F列: Image URL (上書き防止)

    if (prompt && !existingUrl) {
      try {
        // OpenAI DALL-E 3 API 呼び出し
        const imageUrl = callDalleAPI(prompt); 
        
        // 画像をBlobとして取得
        const imageBlob = UrlFetchApp.fetch(imageUrl).getBlob().setName(`image_${i}.png`);
        
        // ドライブに保存
        const file = folder.createFile(imageBlob);
        file.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
        
        // URLをF列に書き込み (ダイレクトリンク形式)
        const directLink = "https://drive.google.com/uc?export=view&id=" + file.getId();
        sheet.getRange(i + 1, 6).setValue(directLink);
        
        // Utilities.sleep(1000); // レート制限対策

      } catch (e) {
        console.log(`Row ${i+1} Error: ${e.message}`);
        sheet.getRange(i + 1, 6).setValue("Error: " + e.message);
      }
    }
  }
  ui.alert('画像生成完了！');
}

// ヘルパー関数: DALL-E API呼び出し
function callDalleAPI(prompt) {
  const apiKey = PropertiesService.getScriptProperties().getProperty("OPENAI_API_KEY");
  const url = "https://api.openai.com/v1/images/generations";
  
  const payload = {
    "model": "dall-e-3",
    "prompt": prompt,
    "n": 1,
    "size": "1024x1024"
  };

  const options = {
    "method": "post",
    "headers": {
      "Authorization": "Bearer " + apiKey,
      "Content-Type": "application/json"
    },
    "payload": JSON.stringify(payload)
  };

  const response = UrlFetchApp.fetch(url, options);
  const json = JSON.parse(response.getContentText());
  return json.data[0].url;
}
```

---

## 3. レポート自動受信機能 (`doPost`)

Pythonツールから送られてくる「日報データ」を受け取るための窓口です。

```javascript
/**
 * 8. レポート自動受信 (WebHook)
 * PythonツールからPOSTされたデータを受け取り、[Report]シートに記録します。
 */
function doPost(e) {
  try {
    const data = JSON.parse(e.postData.contents);
    const date = new Date();
    
    // シート取得または作成
    let sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Report_Log");
    if (!sheet) {
      sheet = SpreadsheetApp.getActiveSpreadsheet().insertSheet("Report_Log");
      sheet.appendRow(["日時", "アカウント", "いいね増加数", "フォロワー増加数", "投稿数"]);
    }

    // データの追記
    sheet.appendRow([
      date,
      data.account_name,
      data.likes_gained,
      data.followers_gained,
      data.posts_count
    ]);

    return ContentService.createTextOutput(JSON.stringify({status: "success"}));

  } catch (error) {
    return ContentService.createTextOutput(JSON.stringify({status: "error", message: error.message}));
  }
}
```

---

## 📝 導入手順

1.  上記コードを `SNS自動化_GAS版.js` にすべてコピペして保存。
2.  **デプロイ**:
    *   GAS画面右上の「デプロイ」>「新しいデプロイ」を選択。
    *   種類の選択: 「ウェブアプリ」。
    *   アクセスできるユーザー: **「全員」** (Pythonツールからアクセスするため)。
    *   **発行された「ウェブアプリURL」をメモ**してください（Pythonツールで使います）。
3.  **メニュー追加**:
    *   `onOpen` 関数の中に `.addItem('6. 競合リサーチ', 'runResearch')` と `.addItem('7. 画像生成(DALL-E)', 'generateDalleImages')` を追加してください。
