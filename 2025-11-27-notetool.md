# 2025-11-27 Notetool 作業メモ

[[obsidian ルール]]

## 今日の作業・議事録
- `notetool/new/main.py` のアカウント保存不具合を修正し、空データが作成される問題を解消。  
- プラン体系（Free1/Free2/Standard/Pro）とオプション（手動バックアップツール）の整理。  
- オンライン連携（Googleスプレッドシート＋GAS API）と端末識別、PayPal Webhook、管理ツール構想を策定。  
- 今後の実装手順を確認：①現行版EXE化 → ②GASシート＋コード → ③PayPal商品/Webhook → ④Python商品版・既存ツール改修 → ⑤管理ツール作成。

## 決定事項
1. **データ連携**  
   - スプレッドシート列：`email, phone, machine_id, plan_type, plan_status, free_expiry, subscription_until, account_limit, sns_limit, save_limit_info, last_hash, device_token1/2, notes, updated_at`。  
   - GAS Webアプリ経由で `auth/login`, `hash-report`, `plan/update` 等のAPIを提供。APIキー＋署名で保護し、必要に応じてSupabase等へ移行できる設計にする。
2. **プラン制御**  
   - Free1（知人配布、無期限）とFree2（一般配布、60日）の機能制限は共通。オフライン利用は不可。  
   - Standard/Proは月額サブスク。PayPal Webhookで課金状態を検証し、変更があれば再ログイン要求。  
   - Proのみ起動時にバックアップ世代を選択可能。
3. **セキュリティ/制限**  
   - 隠しファイルを `%LOCALAPPDATA%` と `%APPDATA%` の目立たない場所に2つ配置し、AES＋HMACで暗号化。内容とサーバーの `device_token` を照合。  
   - プラン情報・制限値はサーバーから受け取り、Python側に固定値を持たせない。  
   - ログイン毎にTLS通信でプラン検証し、失敗回数・タイムアウト・改ざんを監視。  
   - 90日ごとにメール再認証が必要な場合はログイン時に通知し、GASでメール送信→シート更新する運用。
4. **UI/UX**  
   - 「プランを確認」モーダルを追加。制限を超える操作時は「フリープランでは使用できません」等の警告を表示。  
   - Pro向けに終了前の手動バックアップボタン＋ハッシュ変化検知による自動バックアップを実装。  
   - ブラウザ起動ボタンやスクショ機能は既存仕様をベースに継続。

## 注意点メモ（利用規約・告知に反映予定）
- オンライン接続必須。API停止/ネットワーク不調時は利用できないことを明示。  
- 電話番号・メールアドレスを認証・課金管理の目的で保存する旨を説明。  
- Free版は端末ID＋隠しファイル＋オンライン照合で1台限定。再インストール・複製・改ざんは禁止。  
- Standard/Proは月額課金の有効状態を毎回確認し、未払い時は即停止。  
- バックアップ・スクショ・SNS起動などで扱う情報はユーザー責任で管理し、第三者への漏えいに注意。  
- リバースエンジニアリングや異常操作検知時は利用停止やアカウント凍結。  
- APIキーやSECRET_KEYはアプリ内で難読化し、外部流出リスクを最小化する。

## 次のアクション
1. 現行修正版 `main.py` をEXE化して自分用に保管。  
2. GASでスプレッドシート作成・API／メール認証スクリプトを実装。  
3. PayPalでStandard/Proの商品とWebhookを設定し、GAS側で受信→シート更新。  
4. Pythonクライアントを商品版仕様に更新（オンライン認証、制限適用、隠しファイル、バックアップ改善）。必要に応じて既存のキーコードツール・バックアップツールも改修。  
5. 運営用管理ツールを新規作成し、プラン変更や状況確認をGUI/CLIから実施できるようにする。  
6. 90日メール再認証、利用規約ドラフト、注意喚起文章の整備。


